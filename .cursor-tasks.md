# Cursor Tasks – ZenaManage (Laravel 9, PHP 8.2, MySQL, Multi-tenant)

Hướng dẫn nhiệm vụ sẵn dùng cho Cursor + Codex.

**Quy ước: KHÔNG sửa mã khi chưa có bước "Propose Patch".**

**Phạm vi:** app/, routes/, config/, resources/, database/, tests/.

## 0) Context dự án

- Laravel v9.52.20, PHP 8.2, MySQL.
- Multi-tenant (ULID), tenant scope đã bật (PR2).
- PR1 (SEC+PERF), PR2 (TENANCY+RBAC), PR3 (OBS+CI) đã áp.
- Auth: session (web), có RBAC qua Gates/Policies.
- **Mục tiêu hiện tại:** điều tra & vá lỗi "AuthManager is not callable" + bảo trì chất lượng.

---

## TASK-01 — Repo Overview (Chỉ đọc)

**Goal:** Cho tôi bản đồ dự án để định vị nhanh.

**Do:**
- Quét & tóm tắt cấu trúc thư mục chính.
- Liệt kê middleware, service providers, global scopes, helpers không chuẩn (custom).
- Thu thập nơi dùng auth (Auth facade, auth(), app('auth')) – chỉ liệt kê, không sửa.

**Prompt:**
```
You are a senior Laravel engineer working inside Cursor.

Task:
1) Index the project and summarize the folder structure for Laravel: app/, routes/, config/, resources/, database/, tests/.
2) List non-standard/custom items:
   - Middleware under app/Http/Middleware
   - Service providers under app/Providers
   - Traits or global scopes under app/Models/Concerns
   - Helpers (any global functions) under app/** or bootstrap/**
3) Find occurrences of authentication usage (Auth facade, auth(), app('auth')), but DO NOT modify code.

Output:
- Bullet list with file paths + short descriptions (1-2 lines each).
- Do not include vendor/.
- Do not propose changes yet.
```

---

## TASK-02 — Investigate: "AuthManager is not callable"

**Goal:** Xác định file + dòng đang gọi AuthManager như callable.

**Do:**
Tìm pattern "callable nhầm":
- `$x = app('auth'); $x(...)`
- `auth()(...` (không phải `auth('web')`)
- `call_user_func(_array)(auth()` hoặc biến dẫn chiếu đến AuthManager
- Kiểm tra compiled views & cached artifacts chỉ để báo cáo (không sửa).

**Prompt:**
```
Investigate the root cause of "Object of type Illuminate\Auth\AuthManager is not callable".

Search requirements:
- Find variables assigned from app('auth') and then invoked like $var(...).
- Find "auth()(" usages (exclude "auth('web')").
- Find call_user_func/call_user_func_array using auth() or a variable derived from app('auth').
- Also search compiled views: storage/framework/views and cached bootstrap files for the same patterns (report only).

Output:
- Exact file path + line numbers for each hit.
- Include 5–10 lines of surrounding code for context.
- Provide a short hypothesis of the most likely culprit.
- Do NOT apply code changes yet.
```

---

## TASK-03 — Propose Patch (Minimal & Safe)

**Goal:** Đưa ra diff tối thiểu, an toàn, sẵn sàng áp dụng.

**Nguyên tắc:**
- Đổi callable-style → `Auth::...` hoặc `auth()->...`.
- Guards an toàn trong Providers/Scopes: `if (app()->bound('auth') && Auth::check()) { ... }`
- Không thay đổi public API trừ khi bắt buộc.
- Với mỗi file: cung cấp unified diff (`diff …`).

**Prompt:**
```
Based on your investigation, propose minimal patches to fix the "AuthManager is not callable" issue.

Rules:
- Replace any callable-style usages with proper Auth::... or auth()->... calls.
- In global scopes/providers, add safety guards: check app()->bound('auth') and Auth::check().
- Keep changes minimal. Do not change public method signatures unless necessary.
- For each file, provide a unified diff (```diff blocks) ready to apply.
- Do not apply changes yet. Wait for my approval.
```

---

## TASK-04 — Apply & Test

**Goal:** Áp dụng patch và xác minh bằng test & cache.

**Lệnh cần chạy (Terminal trong Cursor):**
```bash
composer install -o
php artisan optimize:clear
php artisan test --env=testing
php artisan route:cache
php artisan config:cache
```

**Prompt:**
```
Apply the previously approved diffs.
Then execute:
- composer install -o
- php artisan optimize:clear
- php artisan test --env=testing
- php artisan route:cache
- php artisan config:cache

Report:
- List changed files.
- Test summary (pass/fail with failing tests output).
- If failures occur, show the errors and propose precise follow-up diffs (minimal changes).
```

---

## TASK-05 — Deep Audit Auth Usage (Phòng ngừa tái phát)

**Goal:** Rà soát toàn repo tránh lỗi tương tự về sau.

**Do:**
Tìm & đề xuất chuẩn hoá:
- Biến trung gian từ container: `app('auth')` → thay bằng `Auth::...` hoặc `auth('web')`.
- Gọi `auth()` trong `register()` của Providers → chuyển sang `boot()` + guard an toàn.
- Global scopes/observers gọi `auth()` → thêm guard `app()->bound('auth') && Auth::check()`.
- Không định nghĩa `function auth(...)` trong helpers.

**Prompt:**
```
Perform a deep audit of auth usage patterns:
- Replace or propose replacing app('auth') variables with Auth::... or auth('web')->...
- Ensure no auth() usage happens in Providers::register().
- Ensure global scopes and observers guard auth usage with app()->bound('auth') && Auth::check().
- Ensure no custom helper function named "auth" exists.

Output:
- A checklist of findings with file paths and proposed changes (diffs in ```diff blocks).
- Do not apply changes until I approve.
```

---

## TASK-06 — Route/Kernel Consistency (Guardrails)

**Goal:** Giữ chuẩn middleware & route conventions sau khi sửa.

**Do:**
- Xác nhận web group có: StartSession, ShareErrorsFromSession, VerifyCsrfToken, SubstituteBindings.
- Tránh alias trùng key trong Kernel.
- api group có throttle:api + SubstituteBindings.
- Routes /app/* dùng ['web','auth:web'] + ->scopeBindings().

**Prompt:**
```
Validate Kernel and routes consistency:

Check:
- 'web' group includes StartSession, ShareErrorsFromSession, VerifyCsrfToken, SubstituteBindings.
- 'api' group includes throttle:api and SubstituteBindings.
- No duplicate alias keys in Kernel (e.g., 'security.headers', 'rate.limit').
- All /app/* routes use ['web','auth:web'] and the route group sets ->scopeBindings().
- No duplicate route names or URIs.

Output:
- Pass/Fail per item with file paths and line numbers.
- Provide diffs to fix any violations, but do not apply until I approve.
```

---

## TASK-07 — Post-Fix Regression Tests (Auth/Tenancy)

**Goal:** Khoá chặt hành vi sau khi vá.

**Do:**
Thêm/điều chỉnh tests:
- Tenancy isolation: cross-tenant → 404.
- RBAC: member 403 khi action nhạy cảm (Quotes, Clients delete).
- Documents: upload/download 200, đúng mimetype, không leak tenant.
- Quotes: send/accept/reject chuyển trạng thái thật.

**Prompt:**
```
Propose or update tests to protect the fixes:
- Tenancy isolation tests for Projects/Tasks/Clients/Quotes (404 cross-tenant).
- RBAC tests for member vs pm/super_admin.
- Documents upload/download tests with storage assertions.
- Quotes state transition tests.

Output:
- List test files to add/modify with code snippets.
- Do not apply until I approve.
```

---

## TASK-08 — Commit/PR

**Goal:** Gom các thay đổi đã duyệt thành 1 commit/PR rõ ràng.

**Prompt:**
```
Create a single commit with message:

fix(auth): prevent AuthManager callable misuse; guard providers/scopes; add tests

Then:
- List all changed files grouped by purpose (fixes vs tests).
- If GitHub is connected, open a PR with the commit, add a summary and risks section.
```

---

## Phụ lục — Lệnh hữu ích (Terminal)

**Clear/cached:**
```bash
php artisan optimize:clear
php artisan route:clear
php artisan config:clear
php artisan view:clear
composer dump-autoload -o
```

**Test chọn lọc:**
```bash
php artisan test --filter=Tenancy
php artisan test --filter=Rbac
php artisan test --filter=Documents
php artisan test --filter=Quotes
```

**Dusk (nếu dùng):**
```bash
php artisan dusk
```

---

**Lưu ý:** Mọi thay đổi lớn hãy đi theo chu trình: Investigate → Propose Patch → Apply → Test → Commit/PR.

**Chỉ áp diff sau khi đã đọc & duyệt nội dung.**
