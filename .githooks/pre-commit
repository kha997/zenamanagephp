#!/bin/bash

# Pre-commit hook for duplicate detection
# This hook runs before each commit to check for duplicate code

echo "üîç Running pre-commit duplicate detection..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_error "Not in a git repository"
    exit 1
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    print_status "No staged files to check"
    exit 0
fi

# Check for duplicate patterns in staged files
DUPLICATE_FOUND=false

echo "üìä Checking staged files for duplicate patterns..."

# Check for duplicate header components
HEADER_FILES=$(echo "$STAGED_FILES" | grep -E "(header|Header)" | wc -l)
if [ $HEADER_FILES -gt 1 ]; then
    print_warning "Found $HEADER_FILES header-related files in this commit"
    echo "$STAGED_FILES" | grep -E "(header|Header)" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate layout files
LAYOUT_FILES=$(echo "$STAGED_FILES" | grep -E "layout" | wc -l)
if [ $LAYOUT_FILES -gt 1 ]; then
    print_warning "Found $LAYOUT_FILES layout files in this commit"
    echo "$STAGED_FILES" | grep -E "layout" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate dashboard files
DASHBOARD_FILES=$(echo "$STAGED_FILES" | grep -E "dashboard" | wc -l)
if [ $DASHBOARD_FILES -gt 1 ]; then
    print_warning "Found $DASHBOARD_FILES dashboard files in this commit"
    echo "$STAGED_FILES" | grep -E "dashboard" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate project files
PROJECT_FILES=$(echo "$STAGED_FILES" | grep -E "project" | wc -l)
if [ $PROJECT_FILES -gt 2 ]; then
    print_warning "Found $PROJECT_FILES project files in this commit"
    echo "$STAGED_FILES" | grep -E "project" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate middleware files
MIDDLEWARE_FILES=$(echo "$STAGED_FILES" | grep -E "Middleware" | wc -l)
if [ $MIDDLEWARE_FILES -gt 1 ]; then
    print_warning "Found $MIDDLEWARE_FILES middleware files in this commit"
    echo "$STAGED_FILES" | grep -E "Middleware" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate controller files
CONTROLLER_FILES=$(echo "$STAGED_FILES" | grep -E "Controller" | wc -l)
if [ $CONTROLLER_FILES -gt 2 ]; then
    print_warning "Found $CONTROLLER_FILES controller files in this commit"
    echo "$STAGED_FILES" | grep -E "Controller" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate service files
SERVICE_FILES=$(echo "$STAGED_FILES" | grep -E "Service" | wc -l)
if [ $SERVICE_FILES -gt 2 ]; then
    print_warning "Found $SERVICE_FILES service files in this commit"
    echo "$STAGED_FILES" | grep -E "Service" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate request files
REQUEST_FILES=$(echo "$STAGED_FILES" | grep -E "Request" | wc -l)
if [ $REQUEST_FILES -gt 2 ]; then
    print_warning "Found $REQUEST_FILES request files in this commit"
    echo "$STAGED_FILES" | grep -E "Request" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate React components
REACT_FILES=$(echo "$STAGED_FILES" | grep -E "\.(tsx|jsx)$" | wc -l)
if [ $REACT_FILES -gt 3 ]; then
    print_warning "Found $REACT_FILES React components in this commit"
    echo "$STAGED_FILES" | grep -E "\.(tsx|jsx)$" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate Blade components
BLADE_FILES=$(echo "$STAGED_FILES" | grep -E "\.blade\.php$" | wc -l)
if [ $BLADE_FILES -gt 3 ]; then
    print_warning "Found $BLADE_FILES Blade components in this commit"
    echo "$STAGED_FILES" | grep -E "\.blade\.php$" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for similar file names (potential duplicates)
echo "üîç Checking for similar file names..."
SIMILAR_FILES=$(echo "$STAGED_FILES" | sed 's/.*\///' | sed 's/\.[^.]*$//' | sort | uniq -d)
if [ ! -z "$SIMILAR_FILES" ]; then
    print_warning "Found files with similar names (potential duplicates):"
    echo "$SIMILAR_FILES" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for hardcoded values that might indicate duplication
echo "üîç Checking for hardcoded values that might indicate duplication..."
HARDCODED_FILES=$(echo "$STAGED_FILES" | xargs grep -l "hardcoded\|mock\|dummy\|fake\|sample\|test.*data" 2>/dev/null || true)
if [ ! -z "$HARDCODED_FILES" ]; then
    print_warning "Found files with hardcoded/mock data:"
    echo "$HARDCODED_FILES" | sed 's/^/  - /'
    DUPLICATE_FOUND=true
fi

# Check for duplicate code blocks (simple check)
echo "üîç Checking for duplicate code blocks..."
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Check for duplicate function definitions
        FUNCTIONS=$(grep -n "function\|class\|interface\|trait" "$file" 2>/dev/null | cut -d: -f2 | sort | uniq -d)
        if [ ! -z "$FUNCTIONS" ]; then
            print_warning "Found duplicate definitions in $file:"
            echo "$FUNCTIONS" | sed 's/^/  - /'
            DUPLICATE_FOUND=true
        fi
    fi
done

# Summary
echo ""
if [ "$DUPLICATE_FOUND" = true ]; then
    print_warning "Duplicate patterns detected in staged files!"
    echo ""
    echo "üìã Recommendations:"
    echo "  - Review the files listed above for potential duplication"
    echo "  - Consider consolidating similar functionality"
    echo "  - Use shared components/services to reduce duplication"
    echo "  - If duplication is intentional, add a comment explaining why"
    echo ""
    echo "‚ö†Ô∏è  You can still commit by using: git commit --no-verify"
    echo "   But consider addressing the duplication issues first."
    echo ""
    read -p "Do you want to continue with the commit? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_error "Commit aborted due to duplicate patterns"
        exit 1
    fi
else
    print_status "No duplicate patterns detected in staged files"
fi

print_status "Pre-commit duplicate detection completed"
exit 0
