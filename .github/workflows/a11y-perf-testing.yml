name: Accessibility & Performance Testing

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # Nightly at 3 AM

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'

jobs:
  accessibility-tests:
    name: Accessibility Tests (WCAG 2.1 AA)
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: zenamanage_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache
        coverage: pcov
        ini-values: |
          pcov.enabled=1
          pcov.directory=app
          pcov.exclude="~vendor~"

    - name: Verify PCOV loaded
      run: php -m | grep -i pcov

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Setup environment
      run: |
        cp .env.example .env
        php artisan key:generate
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    - name: Run database migrations
      run: php artisan migrate --env=testing --force

    - name: Run accessibility tests
      run: php artisan test tests/Feature/Accessibility --stop-on-failure

    - name: Generate accessibility report
      run: |
        php artisan test tests/Feature/Accessibility --coverage --coverage-clover=coverage.xml
        php artisan test tests/Feature/Accessibility --junit --log-junit=accessibility-results.xml

    - name: Upload accessibility coverage
      uses: codecov/codecov-action@v3
      with:
        file: coverage.xml
        flags: accessibility
        name: accessibility-coverage

  performance-budget:
    name: Performance Budget Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      APP_ENV: testing
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: zenamanage_test
      DB_USERNAME: test_user
      DB_PASSWORD: test_password
      DB_SOCKET: ''
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: zenamanage_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Setup environment
      run: cp .env.example .env

    - name: Prepare testing environment
      env:
        ENV_FILE: .env
      run: ./.github/scripts/ci_prepare_testing_env.sh

    - name: Run database migrations
      run: php artisan migrate --env=testing --force

    - name: Run performance budget tests
      run: ./vendor/bin/phpunit -c phpunit.xml --group performance_budget --stop-on-failure --log-junit=performance-budget-results.xml

    - name: Upload performance budget results
      uses: actions/upload-artifact@v4
      with:
        name: performance-budget-results
        path: performance-budget-results.xml

  performance-heavy:
    name: Performance Heavy Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      APP_ENV: testing
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: zenamanage_test
      DB_USERNAME: test_user
      DB_PASSWORD: test_password
      DB_SOCKET: ''
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: zenamanage_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Setup environment
      run: cp .env.example .env

    - name: Prepare testing environment
      env:
        ENV_FILE: .env
      run: ./.github/scripts/ci_prepare_testing_env.sh

    - name: Run database migrations
      run: php artisan migrate --env=testing --force

    - name: Run performance heavy tests
      run: PERF_ITERATIONS=1 PERF_SEED_COUNT=10 ./vendor/bin/phpunit -c phpunit.xml --group performance_heavy --stop-on-failure --log-junit=performance-heavy-results.xml

    - name: Upload performance heavy results
      uses: actions/upload-artifact@v4
      with:
        name: performance-heavy-results
        path: performance-heavy-results.xml

  lighthouse-ci:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: zenamanage_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Setup environment
      run: |
        cp .env.example .env
        php artisan key:generate
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    - name: Run database migrations
      run: php artisan migrate --force

    - name: Start Laravel server
      run: |
        php artisan serve --host=0.0.0.0 --port=8000 &
        sleep 10

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install Lighthouse CI
      run: npm install -g @lhci/cli@0.12.x

    - name: Run Lighthouse CI
      run: |
        lhci autorun --upload.target=temporary-public-storage --collect.url=http://localhost:8000/app/dashboard

    - name: Upload Lighthouse results
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-results
        path: .lighthouseci/

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: zenamanage_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Setup environment
      run: |
        cp .env.example .env
        php artisan key:generate
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    - name: Run database migrations
      run: php artisan migrate --force

    - name: Run E2E tests
      run: php artisan test tests/E2E --stop-on-failure

    - name: Generate E2E report
      run: |
        php artisan test tests/E2E --junit --log-junit=e2e-results.xml

    - name: Upload E2E results
      uses: actions/upload-artifact@v4
      with:
        name: e2e-results
        path: e2e-results.xml

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [accessibility-tests, performance-budget, performance-heavy, lighthouse-ci, e2e-tests]
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Generate test summary
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Accessibility Tests" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ needs.accessibility-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Performance Budget Tests" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ needs.performance-budget.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Performance Heavy Tests" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ needs.performance-heavy.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Lighthouse CI" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ needs.lighthouse-ci.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### E2E Tests" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
