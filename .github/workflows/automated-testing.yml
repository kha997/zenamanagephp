name: Automated Testing

on:
  workflow_dispatch:
  push:
    branches: [ main, develop, 'feature/*' ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: zenamanage_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache
        coverage: xdebug

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-suggest

    - name: Copy environment file
      run: cp .env.example .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Create database
      run: |
        mysql -h 127.0.0.1 -u test_user -ptest_password -e "CREATE DATABASE IF NOT EXISTS zenamanage_test;"

    - name: Run database migrations
      run: php artisan migrate --env=testing --force

    - name: Run database seeders
      run: php artisan db:seed --env=testing --force

    - name: Run Unit Tests
      run: php artisan test tests/Unit --coverage --coverage-clover=coverage-unit.xml

    - name: Upload Unit Test Coverage
      uses: codecov/codecov-action@v3
      with:
        file: coverage-unit.xml
        flags: unittests
        name: unit-tests

  feature-tests:
    name: Feature Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: zenamanage_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache
        coverage: xdebug

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-suggest

    - name: Copy environment file
      run: cp .env.example .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Create database
      run: |
        mysql -h 127.0.0.1 -u test_user -ptest_password -e "CREATE DATABASE IF NOT EXISTS zenamanage_test;"

    - name: Run database migrations
      run: php artisan migrate --env=testing --force

    - name: Run database seeders
      run: php artisan db:seed --env=testing --force

    - name: Run Feature Tests
      run: php artisan test tests/Feature --coverage --coverage-clover=coverage-feature.xml

    - name: Upload Feature Test Coverage
      uses: codecov/codecov-action@v3
      with:
        file: coverage-feature.xml
        flags: featuretests
        name: feature-tests

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: zenamanage_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache
        coverage: xdebug

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-suggest

    - name: Copy environment file
      run: cp .env.example .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Create database
      run: |
        mysql -h 127.0.0.1 -u test_user -ptest_password -e "CREATE DATABASE IF NOT EXISTS zenamanage_test;"

    - name: Run database migrations
      run: php artisan migrate --env=testing --force

    - name: Run database seeders
      run: php artisan db:seed --env=testing --force

    - name: Run Integration Tests
      run: php artisan test tests/Integration --coverage --coverage-clover=coverage-integration.xml

    - name: Upload Integration Test Coverage
      uses: codecov/codecov-action@v3
      with:
        file: coverage-integration.xml
        flags: integrationtests
        name: integration-tests

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: zenamanage_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-suggest

    - name: Copy environment file
      run: cp .env.example .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Create database
      run: |
        mysql -h 127.0.0.1 -u test_user -ptest_password -e "CREATE DATABASE IF NOT EXISTS zenamanage_test;"

    - name: Run database migrations
      run: php artisan migrate --env=testing --force

    - name: Run database seeders
      run: php artisan db:seed --env=testing --force

    - name: Run Performance Tests
      run: php artisan test tests/Performance

    - name: Generate Performance Report
      run: |
        echo "Performance test results:" > performance-report.txt
        echo "=========================" >> performance-report.txt
        # Add performance metrics here

    - name: Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: performance-report.txt

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, gd, zip, bcmath, opcache

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-suggest

    - name: Run Security Audit
      run: composer audit || true

    - name: Run PHPStan Static Analysis
      run: |
        composer require --dev phpstan/phpstan
        ./vendor/bin/phpstan analyse --level=8 --error-format=json > phpstan-report.json

    - name: Upload PHPStan Report
      uses: actions/upload-artifact@v4
      with:
        name: phpstan-report
        path: phpstan-report.json

    - name: Run PHP CS Fixer
      run: |
        composer require --dev friendsofphp/php-cs-fixer
        ./vendor/bin/php-cs-fixer fix --dry-run --diff --format=json > cs-fixer-report.json

    - name: Upload CS Fixer Report
      uses: actions/upload-artifact@v4
      with:
        name: cs-fixer-report
        path: cs-fixer-report.json

  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests, feature-tests, integration-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Unit Test Coverage
      uses: actions/download-artifact@v4
      with:
        name: unit-test-coverage
        path: coverage/

    - name: Download Feature Test Coverage
      uses: actions/download-artifact@v4
      with:
        name: feature-test-coverage
        path: coverage/

    - name: Download Integration Test Coverage
      uses: actions/download-artifact@v4
      with:
        name: integration-test-coverage
        path: coverage/

    - name: Generate Combined Coverage Report
      run: |
        echo "Combined test coverage report:" > coverage-summary.txt
        echo "==============================" >> coverage-summary.txt
        echo "Unit Tests: $(cat coverage/unit-coverage.txt)" >> coverage-summary.txt
        echo "Feature Tests: $(cat coverage/feature-coverage.txt)" >> coverage-summary.txt
        echo "Integration Tests: $(cat coverage/integration-coverage.txt)" >> coverage-summary.txt

    - name: Upload Combined Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: combined-coverage-report
        path: coverage-summary.txt

    - name: Comment Coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const coverage = fs.readFileSync('coverage-summary.txt', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## Test Coverage Report\n\`\`\`\n${coverage}\n\`\`\``
          });
