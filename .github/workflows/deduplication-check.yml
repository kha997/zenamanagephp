name: Enhanced Duplication Check
on: 
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  duplication-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, iconv, json, mbstring, pdo, session, simplexml, tokenizer, xml, zip
          
      - name: Install Node dependencies
        run: npm ci
        
      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader
        
      - name: Create reports directory
        run: mkdir -p reports
        
      - name: Check JavaScript duplication with jscpd
        run: |
          echo "ðŸ” Checking JavaScript/TypeScript duplication..."
          npx jscpd --min-lines 10 --min-tokens 50 --threshold 5 --reporters console,html,json --output ./reports/jscpd resources/js src/ || true
          
      - name: Check PHP duplication with phpcpd
        run: |
          echo "ðŸ” Checking PHP duplication..."
          if ! command -v phpcpd &> /dev/null; then
            echo "Installing phpcpd..."
            composer global require sebastian/phpcpd
          fi
          ~/.composer/vendor/bin/phpcpd --min-lines 10 --min-tokens 50 --log-pmd ./reports/phpcpd.xml app/ || true
          
      - name: Check PHP syntax
        run: |
          echo "ðŸ” Checking PHP syntax..."
          find app/ -name "*.php" -exec php -l {} \; | grep -v "No syntax errors" || true
          
      - name: ESLint with SonarJS rules
        run: |
          echo "ðŸ” Running ESLint with SonarJS rules..."
          npx eslint resources/js src/ --ext .js,.ts,.jsx,.tsx --config .eslintrc.sonarjs.js --format json --output-file ./reports/eslint.json || true
          
      - name: Check for duplicate code patterns
        run: |
          echo "ðŸ” Checking for common duplicate patterns..."
          
          # Check for duplicate header components
          HEADER_FILES=$(find resources/views -name "*header*" -type f | wc -l)
          if [ $HEADER_FILES -gt 2 ]; then
            echo "âš ï¸  Found $HEADER_FILES header files - consider consolidating"
            echo "HEADER_DUPLICATION_WARNING=true" >> $GITHUB_ENV
          else
            echo "âœ… Header files count: $HEADER_FILES"
          fi
          
          # Check for duplicate layout files
          LAYOUT_FILES=$(find resources/views/layouts -name "app*.blade.php" -type f | wc -l)
          if [ $LAYOUT_FILES -gt 1 ]; then
            echo "âš ï¸  Found $LAYOUT_FILES layout files - consider consolidating"
            echo "LAYOUT_DUPLICATION_WARNING=true" >> $GITHUB_ENV
          else
            echo "âœ… Layout files count: $LAYOUT_FILES"
          fi
          
          # Check for duplicate dashboard files
          DASHBOARD_FILES=$(find resources/views/app -name "*dashboard*" -type f | wc -l)
          if [ $DASHBOARD_FILES -gt 1 ]; then
            echo "âš ï¸  Found $DASHBOARD_FILES dashboard files - consider consolidating"
            echo "DASHBOARD_DUPLICATION_WARNING=true" >> $GITHUB_ENV
          else
            echo "âœ… Dashboard files count: $DASHBOARD_FILES"
          fi
          
          # Check for duplicate project files
          PROJECT_FILES=$(find resources/views/app -name "*project*" -type f | wc -l)
          if [ $PROJECT_FILES -gt 2 ]; then
            echo "âš ï¸  Found $PROJECT_FILES project files - consider consolidating"
            echo "PROJECT_DUPLICATION_WARNING=true" >> $GITHUB_ENV
          else
            echo "âœ… Project files count: $PROJECT_FILES"
          fi
          
          # Check for duplicate middleware files
          MIDDLEWARE_FILES=$(find app/Http/Middleware -name "*.php" -type f | wc -l)
          if [ $MIDDLEWARE_FILES -gt 15 ]; then
            echo "âš ï¸  Found $MIDDLEWARE_FILES middleware files - consider consolidating"
            echo "MIDDLEWARE_DUPLICATION_WARNING=true" >> $GITHUB_ENV
          else
            echo "âœ… Middleware files count: $MIDDLEWARE_FILES"
          fi
          
          # Check for duplicate controller files
          CONTROLLER_FILES=$(find app/Http/Controllers -name "*.php" -type f | wc -l)
          if [ $CONTROLLER_FILES -gt 20 ]; then
            echo "âš ï¸  Found $CONTROLLER_FILES controller files - consider consolidating"
            echo "CONTROLLER_DUPLICATION_WARNING=true" >> $GITHUB_ENV
          else
            echo "âœ… Controller files count: $CONTROLLER_FILES"
          fi
          
      - name: Check for unused files
        run: |
          echo "ðŸ” Checking for unused files..."
          
          # Check for unused Blade components
          UNUSED_COMPONENTS=$(find resources/views/components -name "*.blade.php" -type f | wc -l)
          echo "ðŸ“Š Total Blade components: $UNUSED_COMPONENTS"
          
          # Check for unused React components
          UNUSED_REACT=$(find resources/js -name "*.tsx" -o -name "*.jsx" | wc -l)
          echo "ðŸ“Š Total React components: $UNUSED_REACT"
          
      - name: Generate duplication report
        run: |
          echo "ðŸ“Š Generating duplication report..."
          
          # Create summary report
          cat > ./reports/duplication-summary.md << EOF
          # Duplication Check Summary
          
          ## JavaScript/TypeScript Duplication
          - Report: jscpd.html
          - JSON Report: jscpd.json
          
          ## PHP Duplication
          - Report: phpcpd.xml
          
          ## Code Quality
          - ESLint Report: eslint.json
          
          ## File Count Analysis
          - Header Files: \$(find resources/views -name "*header*" -type f | wc -l)
          - Layout Files: \$(find resources/views/layouts -name "app*.blade.php" -type f | wc -l)
          - Dashboard Files: \$(find resources/views/app -name "*dashboard*" -type f | wc -l)
          - Project Files: \$(find resources/views/app -name "*project*" -type f | wc -l)
          - Middleware Files: \$(find app/Http/Middleware -name "*.php" -type f | wc -l)
          - Controller Files: \$(find app/Http/Controllers -name "*.php" -type f | wc -l)
          
          ## Recommendations
          1. Review duplicate code clusters identified in reports
          2. Consider consolidating similar components
          3. Use shared components to reduce duplication
          4. Implement code review guidelines to prevent future duplication
          EOF
          
      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: duplication-reports
          path: reports/
          
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## ðŸ” Enhanced Duplication Check Results\n\n';
            
            // Check if reports exist
            if (fs.existsSync('./reports/jscpd')) {
              comment += '### JavaScript/TypeScript Duplication\n';
              comment += 'âœ… JavaScript duplication check completed\n';
              comment += '- Report: [jscpd.html](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n';
            }
            
            if (fs.existsSync('./reports/phpcpd.xml')) {
              comment += '### PHP Duplication\n';
              comment += 'âœ… PHP duplication check completed\n';
              comment += '- Report: [phpcpd.xml](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n';
            }
            
            if (fs.existsSync('./reports/eslint.json')) {
              const eslintReport = JSON.parse(fs.readFileSync('./reports/eslint.json', 'utf8'));
              const errorCount = eslintReport.reduce((sum, file) => sum + file.errorCount, 0);
              const warningCount = eslintReport.reduce((sum, file) => sum + file.warningCount, 0);
              
              comment += '### Code Quality\n';
              comment += `- Errors: ${errorCount}\n`;
              comment += `- Warnings: ${warningCount}\n\n`;
            }
            
            // Add warnings if any
            const warnings = [];
            if (process.env.HEADER_DUPLICATION_WARNING) warnings.push('Header files duplication detected');
            if (process.env.LAYOUT_DUPLICATION_WARNING) warnings.push('Layout files duplication detected');
            if (process.env.DASHBOARD_DUPLICATION_WARNING) warnings.push('Dashboard files duplication detected');
            if (process.env.PROJECT_DUPLICATION_WARNING) warnings.push('Project files duplication detected');
            if (process.env.MIDDLEWARE_DUPLICATION_WARNING) warnings.push('Middleware files duplication detected');
            if (process.env.CONTROLLER_DUPLICATION_WARNING) warnings.push('Controller files duplication detected');
            
            if (warnings.length > 0) {
              comment += '### âš ï¸ Warnings\n';
              warnings.forEach(warning => {
                comment += `- ${warning}\n`;
              });
              comment += '\n';
            }
            
            comment += '### ðŸ“Š File Count Analysis\n';
            comment += '- Header Files: ' + (fs.existsSync('./reports/duplication-summary.md') ? 'See report' : 'N/A') + '\n';
            comment += '- Layout Files: ' + (fs.existsSync('./reports/duplication-summary.md') ? 'See report' : 'N/A') + '\n';
            comment += '- Dashboard Files: ' + (fs.existsSync('./reports/duplication-summary.md') ? 'See report' : 'N/A') + '\n';
            comment += '- Project Files: ' + (fs.existsSync('./reports/duplication-summary.md') ? 'See report' : 'N/A') + '\n';
            comment += '- Middleware Files: ' + (fs.existsSync('./reports/duplication-summary.md') ? 'See report' : 'N/A') + '\n';
            comment += '- Controller Files: ' + (fs.existsSync('./reports/duplication-summary.md') ? 'See report' : 'N/A') + '\n\n';
            
            comment += '### Recommendations\n';
            comment += '- Review duplicate code clusters identified in reports\n';
            comment += '- Consider consolidating similar components\n';
            comment += '- Use shared components to reduce duplication\n';
            comment += '- Implement code review guidelines to prevent future duplication\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
