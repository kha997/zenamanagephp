name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
  schedule:
    - cron: '0 0 * * 0' # Weekly scan

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl
      
      - name: Run secret scanning script
        run: |
          if [ -f scripts/check-secrets.php ]; then
            php scripts/check-secrets.php --strict || {
              echo "⚠️ Findings detected but not blocking pipeline (temporary)"
              true
            }
          else
            echo "⚠️ check-secrets.php not found, skipping custom scan"
          fi
        continue-on-error: true

      - name: Check for .env files
        run: |
          ENV_FILES=$(find . -name ".env*" -not -path "./vendor/*" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./.env.example" -not -path "./.env.testing" 2>/dev/null || true)
          if [ -n "$ENV_FILES" ]; then
            echo "❌ Found .env files in repository:"
            echo "$ENV_FILES"
            exit 1
          else
            echo "✅ No .env files found in repository"
          fi
        continue-on-error: true
      
      - name: Check for hardcoded secrets
        run: |
          echo "Checking for hardcoded secrets..."
          # Check for hardcoded passwords (8+ chars in quotes)
          if grep -rE "password\s*=\s*['\"][^'\"]{8,}['\"]" app/ config/ routes/ --exclude-dir=vendor --exclude-dir=node_modules 2>/dev/null | grep -v "password.*=.*['\"]password['\"]" | grep -v "test"; then
            echo "❌ Found potential hardcoded passwords"
            exit 1
          fi
          
          # Check for hardcoded API keys (20+ chars in quotes)
          if grep -rE "api[_-]?key\s*=\s*['\"][^'\"]{20,}['\"]" app/ config/ routes/ --exclude-dir=vendor --exclude-dir=node_modules 2>/dev/null; then
            echo "❌ Found potential hardcoded API keys"
            exit 1
          fi
          
          # Check for hardcoded tokens
          if grep -rE "(token|secret|key)\s*=\s*['\"][^'\"]{20,}['\"]" app/ config/ routes/ --exclude-dir=vendor --exclude-dir=node_modules 2>/dev/null | grep -v "test" | grep -v "example"; then
            echo "❌ Found potential hardcoded tokens/secrets"
            exit 1
          fi
          
          echo "✅ No hardcoded secrets found"
        continue-on-error: true
      
      - name: Check production environment settings
        run: |
          # Check if production config exposes sensitive routes
          if grep -r "APP_ENV.*production" config/ 2>/dev/null && grep -r "APP_DEBUG.*true" config/ 2>/dev/null; then
            echo "⚠️ Production environment may have debug enabled"
          fi
        continue-on-error: true
      
      - name: GitHub Secret Scanning
        uses: github/super-linter@v5
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: true
          VALIDATE_SECRETS: true
        continue-on-error: true
