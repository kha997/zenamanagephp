name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, dom, fileinfo, mysql
        coverage: none
    
    - name: Install dependencies
      run: |
        composer install --no-dev --optimize-autoloader
        npm ci
    
    - name: Check for dangerous routes
      run: |
        echo "ðŸ” Checking for dangerous test routes..."
        if grep -r "test-login\|auto-login\|debug-auth" routes/; then
          echo "âŒ CRITICAL: Dangerous test routes found!"
          exit 1
        fi
        echo "âœ… No dangerous test routes found"
    
    - name: Check for unprotected login
      run: |
        echo "ðŸ” Checking for unprotected login endpoints..."
        if grep -r "Auth::attempt" routes/ --exclude-dir=vendor; then
          echo "âŒ CRITICAL: Unprotected Auth::attempt found!"
          exit 1
        fi
        echo "âœ… No unprotected login endpoints found"
    
    - name: Check for mock data
      run: |
        echo "ðŸ” Checking for mock data in production..."
        if grep -r "New Project Created\|Task Completed\|Project Owner" resources/views/ app/Http/Controllers/; then
          echo "âŒ CRITICAL: Mock data found in production code!"
          exit 1
        fi
        echo "âœ… No mock data found"
    
    - name: Check for RBAC bypass
      run: |
        echo "ðŸ” Checking for RBAC bypass..."
        if grep -r "return true.*permission\|hasPermission.*true" app/Http/Controllers/; then
          echo "âŒ CRITICAL: RBAC bypass found!"
          exit 1
        fi
        echo "âœ… No RBAC bypass found"
    
    - name: Check for session-based tenant checks
      run: |
        echo "ðŸ” Checking for session-based tenant checks..."
        if grep -r "session.*user" app/Http/Requests/; then
          echo "âŒ CRITICAL: Session-based tenant checks found!"
          exit 1
        fi
        echo "âœ… No session-based tenant checks found"
    
    - name: Check for duplicate middleware
      run: |
        echo "ðŸ” Checking for duplicate rate limiting middleware..."
        rate_middleware_count=$(find . -name "*RateLimit*Middleware.php" | wc -l)
        if [ $rate_middleware_count -gt 1 ]; then
          echo "âŒ CRITICAL: Multiple rate limiting middleware found!"
          find . -name "*RateLimit*Middleware.php"
          exit 1
        fi
        echo "âœ… Single rate limiting middleware found"
    
    - name: Check for duplicate modules
      run: |
        echo "ðŸ” Checking for duplicate modules..."
        if [ -d "src/CoreProject" ]; then
          echo "âŒ CRITICAL: Duplicate CoreProject module found!"
          echo "This module conflicts with app/ directory"
          exit 1
        fi
        echo "âœ… No duplicate modules found"
    
    - name: Check for mixed API responses
      run: |
        echo "ðŸ” Checking for mixed API response formats..."
        if grep -r "JSendResponse" app/Http/Controllers/ && grep -r "ApiResponse" app/Http/Controllers/; then
          echo "âŒ CRITICAL: Mixed API response formats found!"
          echo "Use either JSendResponse or ApiResponse consistently"
          exit 1
        fi
        echo "âœ… Consistent API response format"
    
    - name: Check for duplicate routes
      run: |
        echo "ðŸ” Checking for duplicate route names..."
        php artisan route:list --compact | awk '{print $2}' | sort | uniq -d
        if [ $? -eq 0 ]; then
          echo "âŒ CRITICAL: Duplicate route names found!"
          exit 1
        fi
        echo "âœ… No duplicate route names found"
    
    - name: Run duplicate detection
      run: |
        echo "ðŸ” Running duplicate detection..."
        if command -v jscpd &> /dev/null; then
          jscpd --min-lines 10 --min-tokens 50 resources/js/ || true
        fi
        if command -v phpcpd &> /dev/null; then
          phpcpd --min-lines 10 --min-tokens 50 app/ || true
        fi
    
    - name: Security audit summary
      run: |
        echo "ðŸŽ‰ Security audit completed successfully!"
        echo "âœ… All critical security checks passed"
        echo "âœ… No dangerous routes found"
        echo "âœ… No mock data in production"
        echo "âœ… RBAC properly implemented"
        echo "âœ… Tenancy properly enforced"
        echo "âœ… Rate limiting consistent"
        echo "âœ… No duplicate modules"
        echo "âœ… API responses standardized"
