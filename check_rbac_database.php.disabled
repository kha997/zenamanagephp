<?php declare(strict_types=1);

/**
 * Script kiá»ƒm tra cáº¥u trÃºc database RBAC
 * XÃ¡c minh cÃ¡c báº£ng cáº§n thiáº¿t Ä‘Ã£ Ä‘Æ°á»£c táº¡o vÃ  cÃ³ Ä‘Ãºng cáº¥u trÃºc
 */

require_once __DIR__ . '/bootstrap.php';

echo "ðŸ” Kiá»ƒm tra cáº¥u trÃºc database RBAC...\n\n";

try {
    $db = db();
    $schema = $db->getSchemaBuilder();
    
    // Danh sÃ¡ch cÃ¡c báº£ng RBAC cáº§n kiá»ƒm tra
    $requiredTables = [
        'roles',
        'permissions', 
        'role_permissions',
        'system_user_roles',
        'custom_user_roles',
        'project_user_roles'
    ];
    
    $missingTables = [];
    $existingTables = [];
    
    echo "ðŸ“‹ Kiá»ƒm tra sá»± tá»“n táº¡i cá»§a cÃ¡c báº£ng RBAC:\n";
    
    foreach ($requiredTables as $table) {
        if ($schema->hasTable($table)) {
            $existingTables[] = $table;
            echo "âœ… Báº£ng '{$table}' Ä‘Ã£ tá»“n táº¡i\n";
        } else {
            $missingTables[] = $table;
            echo "âŒ Báº£ng '{$table}' chÆ°a tá»“n táº¡i\n";
        }
    }
    
    echo "\nðŸ“Š Tá»•ng káº¿t:\n";
    echo "- Báº£ng Ä‘Ã£ tá»“n táº¡i: " . count($existingTables) . "/" . count($requiredTables) . "\n";
    echo "- Báº£ng cÃ²n thiáº¿u: " . count($missingTables) . "\n";
    
    if (!empty($missingTables)) {
        echo "\nâš ï¸  CÃ¡c báº£ng cÃ²n thiáº¿u: " . implode(', ', $missingTables) . "\n";
        echo "\nðŸ’¡ Gá»£i Ã½: Cháº¡y migration Ä‘á»ƒ táº¡o cÃ¡c báº£ng cÃ²n thiáº¿u:\n";
        echo "   php artisan migrate\n";
        echo "   hoáº·c cháº¡y: php migrate.php\n";
    }
    
    // Kiá»ƒm tra cáº¥u trÃºc cÃ¡c báº£ng Ä‘Ã£ tá»“n táº¡i
    if (!empty($existingTables)) {
        echo "\nðŸ” Kiá»ƒm tra cáº¥u trÃºc cÃ¡c báº£ng Ä‘Ã£ tá»“n táº¡i:\n";
        
        foreach ($existingTables as $table) {
            echo "\nðŸ“‹ Cáº¥u trÃºc báº£ng '{$table}':\n";
            
            $columns = $schema->getColumnListing($table);
            foreach ($columns as $column) {
                echo "  - {$column}\n";
            }
        }
    }
    
    // Kiá»ƒm tra dá»¯ liá»‡u máº«u
    if (in_array('roles', $existingTables)) {
        echo "\nðŸ“Š Kiá»ƒm tra dá»¯ liá»‡u trong báº£ng 'roles':\n";
        $rolesCount = $db->table('roles')->count();
        echo "  - Tá»•ng sá»‘ roles: {$rolesCount}\n";
        
        if ($rolesCount > 0) {
            $roles = $db->table('roles')->select('name', 'scope')->get();
            foreach ($roles as $role) {
                echo "  - {$role->name} ({$role->scope})\n";
            }
        }
    }
    
    if (in_array('permissions', $existingTables)) {
        echo "\nðŸ“Š Kiá»ƒm tra dá»¯ liá»‡u trong báº£ng 'permissions':\n";
        $permissionsCount = $db->table('permissions')->count();
        echo "  - Tá»•ng sá»‘ permissions: {$permissionsCount}\n";
        
        if ($permissionsCount > 0) {
            $permissions = $db->table('permissions')
                ->select('code', 'module', 'action')
                ->orderBy('module')
                ->orderBy('action')
                ->get();
            
            $groupedPermissions = [];
            foreach ($permissions as $permission) {
                $groupedPermissions[$permission->module][] = $permission->code;
            }
            
            foreach ($groupedPermissions as $module => $codes) {
                echo "  - Module '{$module}': " . count($codes) . " permissions\n";
                foreach ($codes as $code) {
                    echo "    * {$code}\n";
                }
            }
        }
    }
    
    if (count($missingTables) === 0) {
        echo "\nðŸŽ‰ Táº¥t cáº£ báº£ng RBAC Ä‘Ã£ Ä‘Æ°á»£c táº¡o Ä‘áº§y Ä‘á»§!\n";
        echo "âœ… Database RBAC Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ sá»­ dá»¥ng.\n";
    } else {
        echo "\nâš ï¸  Database RBAC chÆ°a hoÃ n chá»‰nh. Cáº§n táº¡o thÃªm " . count($missingTables) . " báº£ng.\n";
    }
    
} catch (Exception $e) {
    echo "âŒ Lá»—i khi kiá»ƒm tra database: " . $e->getMessage() . "\n";
    echo "ðŸ“ File: " . $e->getFile() . " (dÃ²ng " . $e->getLine() . ")\n";
    exit(1);
}