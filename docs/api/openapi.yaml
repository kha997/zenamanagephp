openapi: 3.1.0
info:
  title: ZenaManage API
  version: 1.0.0
  description: |
    Multi-tenant project management system API.
    
    All endpoints require authentication via Bearer token (Sanctum).
    Tenant-scoped endpoints require `ability:tenant` middleware.
    Admin endpoints require `ability:admin` middleware.
    
    **Idempotency:**
    All write operations (POST, PUT, PATCH) support idempotency via the `Idempotency-Key` header.
    Include this header to ensure duplicate requests are handled safely. The same response
    will be returned for requests with the same idempotency key within 24 hours.
    
    Format: `{resource}_{action}_{timestamp}_{nonce}`
    Example: `project_create_1705123456789_abc123xyz`
    
    Use the frontend helper: `generateIdempotencyKey('project', 'create')`

servers:
  - url: https://api.zenamanage.com/api/v1
    description: Production server
  - url: http://localhost:8000/api/v1
    description: Local development server

paths:
  /me:
    get:
      summary: Get current user information
      description: Returns authenticated user information, permissions, and abilities. Unified endpoint for both React and Blade.
      tags:
        - User
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                type: object
                required:
                  - user
                  - permissions
                  - abilities
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  permissions:
                    type: array
                    items:
                      type: string
                    description: List of permissions for the user's role
                    example: ['projects.view', 'tasks.create', 'dashboard.view']
                  abilities:
                    type: array
                    items:
                      type: string
                      enum: [tenant, admin]
                    description: User abilities (tenant-scoped or admin)
                    example: ['tenant']
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

  /me/nav:
    get:
      summary: Get navigation menu
      description: Returns navigation items filtered by user permissions. Unified endpoint for both React and Blade to read the same navigation schema.
      tags:
        - Navigation
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Navigation items with user context
          content:
            application/json:
              schema:
                type: object
                required:
                  - user
                  - permissions
                  - abilities
                  - navigation
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  permissions:
                    type: array
                    items:
                      type: string
                    description: List of permissions for the user's role
                    example: ['projects.view', 'tasks.create', 'dashboard.view']
                  abilities:
                    type: array
                    items:
                      type: string
                      enum: [tenant, admin]
                    description: User abilities (tenant-scoped or admin)
                    example: ['tenant']
                  navigation:
                    type: array
                    items:
                      $ref: '#/components/schemas/NavItem'
                    description: Filtered navigation items based on user permissions
                  admin_access:
                    type: object
                    properties:
                      is_super_admin:
                        type: boolean
                        description: Whether user is a super admin
                      is_org_admin:
                        type: boolean
                        description: Whether user is an org admin (tenant-scoped admin)
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'

  /app/projects:
    get:
      summary: List projects
      description: Get paginated list of projects for the authenticated user's tenant
      tags:
        - Projects
      security:
        - bearerAuth: []
      x-abilities:
        - projects.view
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
        - name: status
          in: query
          schema:
            type: string
            enum: [planning, active, on_hold, completed, cancelled]
      responses:
        '200':
          description: List of projects
          x-abilities:
            - projects.view
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Project'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'
    
    post:
      summary: Create project
      description: Create a new project
      tags:
        - Projects
      security:
        - bearerAuth: []
      x-abilities:
        - projects.create
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreate'
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Project'
                  message:
                    type: string
        '422':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /app/projects/{id}:
    get:
      summary: Get project by ID
      tags:
        - Projects
      security:
        - bearerAuth: []
      x-abilities:
        - projects.view
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Project'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /app/tasks:
    get:
      summary: List tasks
      description: Get paginated list of tasks for the authenticated user's tenant
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.view
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
        - name: status
          in: query
          schema:
            type: string
            enum: [backlog, todo, in_progress, review, done, cancelled]
        - name: project_id
          in: query
          schema:
            type: string
            nullable: true
        - name: priority
          in: query
          schema:
            type: string
            enum: [low, medium, high, urgent]
            nullable: true
        - name: assignee_id
          in: query
          schema:
            type: string
            nullable: true
        - name: search
          in: query
          schema:
            type: string
            nullable: true
      responses:
        '200':
          description: List of tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Task'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/ServerError'
    
    post:
      summary: Create task
      description: Create a new task
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.create
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '201':
          description: Task created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Task'
                  message:
                    type: string
        '422':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /app/tasks/{id}:
    get:
      summary: Get task by ID
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.view
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Task'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    
    put:
      summary: Update task
      description: Update an existing task
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.update
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
      responses:
        '200':
          description: Task updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Task'
                  message:
                    type: string
        '404':
          $ref: '#/components/responses/NotFoundError'
        '422':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    
    patch:
      summary: Partially update task
      description: Partially update an existing task
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.update
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
      responses:
        '200':
          description: Task updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Task'
                  message:
                    type: string
        '404':
          $ref: '#/components/responses/NotFoundError'
        '422':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    
    delete:
      summary: Delete task
      description: Delete a task
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.delete
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /app/tasks/{id}/move:
    patch:
      summary: Move task to new status
      description: Move a task to a new status (Kanban drag-drop). Supports optimistic concurrency control via version field.
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.update
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - to_status
              properties:
                to_status:
                  type: string
                  enum: [backlog, todo, in_progress, review, done, cancelled]
                  description: Target status for the task
                before_id:
                  type: string
                  nullable: true
                  description: Task ID to place this task before (for ordering)
                after_id:
                  type: string
                  nullable: true
                  description: Task ID to place this task after (for ordering)
                reason:
                  type: string
                  nullable: true
                  description: Optional reason for the status change
                version:
                  type: integer
                  nullable: true
                  description: Task version for optimistic concurrency control
      responses:
        '200':
          description: Task moved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Task'
                  warning:
                    type: string
                    nullable: true
                    description: Optional warning message (e.g., if version mismatch was resolved)
        '409':
          description: Conflict - version mismatch or concurrent modification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /app/tasks/bulk-delete:
    post:
      summary: Bulk delete tasks
      description: Delete multiple tasks at once
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.delete
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ids
              properties:
                ids:
                  type: array
                  items:
                    type: string
                  description: Array of task IDs to delete
      responses:
        '200':
          description: Tasks deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      deleted_count:
                        type: integer
        '422':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /app/tasks/bulk-status:
    post:
      summary: Bulk update task status
      description: Update status for multiple tasks at once
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.update
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ids
                - status
              properties:
                ids:
                  type: array
                  items:
                    type: string
                  description: Array of task IDs to update
                status:
                  type: string
                  enum: [backlog, todo, in_progress, review, done, cancelled]
                  description: New status for all tasks
      responses:
        '200':
          description: Tasks updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      updated_count:
                        type: integer
        '422':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /app/tasks/bulk-assign:
    post:
      summary: Bulk assign tasks
      description: Assign multiple tasks to a user at once
      tags:
        - Tasks
      security:
        - bearerAuth: []
      x-abilities:
        - tasks.update
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ids
                - assignee_id
              properties:
                ids:
                  type: array
                  items:
                    type: string
                  description: Array of task IDs to assign
                assignee_id:
                  type: string
                  description: User ID to assign tasks to
      responses:
        '200':
          description: Tasks assigned
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      assigned_count:
                        type: integer
        '422':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/login:
    post:
      summary: Authenticate user
      description: Login and receive authentication token
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      token:
                        type: string
                      token_type:
                        type: string
                        example: 'Bearer'
                      expires_in:
                        type: integer
                      user:
                        $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '422':
          $ref: '#/components/responses/ValidationError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Sanctum token authentication

  schemas:
    User:
      type: object
      required:
        - id
        - name
        - email
        - role
      properties:
        id:
          type: string
          example: '01K83FPK5XGPXF3V7ANJQRGX5X'
        name:
          type: string
          example: 'John Doe'
        email:
          type: string
          format: email
          example: 'john@example.com'
        tenant_id:
          type: string
          nullable: true
          description: Tenant ID for tenant-scoped users, null for super admins
          example: '01K83FPK5XGPXF3V7ANJQRGX5Y'
        role:
          type: string
          enum: [super_admin, org_admin, admin, pm, member, client]
          example: 'member'

    NavItem:
      type: object
      required:
        - path
        - label
        - icon
        - perm
      properties:
        path:
          type: string
          description: Route path for navigation
          example: '/app/dashboard'
        label:
          type: string
          description: Display label for navigation item
          example: 'Dashboard'
        icon:
          type: string
          description: Icon name (matches icon component library)
          example: 'Gauge'
        perm:
          type: string
          description: Required permission to view this navigation item
          example: 'dashboard.view'
        admin:
          type: boolean
          description: Whether this is an admin navigation item
          default: false
        system_only:
          type: boolean
          description: Whether this is a system-only navigation item (super admin only)
          default: false
        tenant_scoped:
          type: boolean
          description: Whether this is a tenant-scoped admin item (org admin)
          default: false

    Project:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [planning, active, on_hold, completed, cancelled]
        progress_pct:
          type: integer
          minimum: 0
          maximum: 100
        tenant_id:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProjectCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [planning, active, on_hold, completed, cancelled]
          default: planning

    Task:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [backlog, todo, in_progress, review, done, cancelled]
        priority:
          type: string
          enum: [low, medium, high, urgent]
        project_id:
          type: string
          nullable: true
        assignee_id:
          type: string
          nullable: true
        tenant_id:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TaskCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [backlog, todo, in_progress, review, done, cancelled]
          default: backlog
        priority:
          type: string
          enum: [low, medium, high, urgent]
          default: medium
        project_id:
          type: string
          nullable: true
        assignee_id:
          type: string
          nullable: true
        due_date:
          type: string
          format: date-time
          nullable: true

    TaskUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [backlog, todo, in_progress, review, done, cancelled]
        priority:
          type: string
          enum: [low, medium, high, urgent]
        project_id:
          type: string
          nullable: true
        assignee_id:
          type: string
          nullable: true
        due_date:
          type: string
          format: date-time
          nullable: true

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - id
            - code
            - message
          properties:
            id:
              type: string
              description: Unique error identifier for correlation
            code:
              type: string
              description: Error code
            message:
              type: string
              description: Human-readable error message
            details:
              type: object
              description: Additional error details
              additionalProperties: true

    PaginationMeta:
      type: object
      properties:
        total:
          type: integer
        per_page:
          type: integer
        current_page:
          type: integer
        last_page:
          type: integer
        from:
          type: integer
          nullable: true
        to:
          type: integer
          nullable: true

    ErrorEnvelope:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - id
            - code
            - message
          properties:
            id:
              type: string
              description: Unique error identifier for correlation
              example: 'req_abc12345'
            code:
              type: string
              description: Error code following pattern E{HTTP_CODE}.{CATEGORY}
              example: 'E422.VALIDATION'
            message:
              type: string
              description: Human-readable error message
              example: 'Validation failed'
            details:
              type: object
              description: Additional error details
              additionalProperties: true

  responses:
    UnauthorizedError:
      description: Unauthorized - Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              id: 'req_xyz789'
              code: 'E401.AUTHENTICATION'
              message: 'Authentication required'

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              id: 'req_xyz789'
              code: 'E404.NOT_FOUND'
              message: 'Resource not found'

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              id: 'req_xyz789'
              code: 'E422.VALIDATION'
              message: 'Validation failed'
              details:
                validation:
                  name:
                    - 'The name field is required.'

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              id: 'req_xyz789'
              code: 'E500.SERVER_ERROR'
              message: 'Internal server error'

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: |
        Idempotency key for write operations (POST, PUT, PATCH).
        Format: {resource}_{action}_{timestamp}_{nonce}
        Example: project_create_1705123456789_abc123xyz
      schema:
        type: string
        pattern: '^[a-z_]+_[a-z_]+_\d+_[a-z0-9]+$'
      example: 'project_create_1705123456789_abc123xyz'

