# ZenaManage ‚Äì Ki·∫øn tr√∫c to√†n h·ªá th·ªëng cho GPT‚Äë5

## 1. T·ªïng quan h·ªá th·ªëng

- **Lo·∫°i ki·∫øn tr√∫c**
  - Monolith Laravel: Backend PHP/Laravel 10 ch·∫°y nh∆∞ m·ªôt ·ª©ng d·ª•ng ƒë∆°n, t·ªï ch·ª©c theo service layer, nhi·ªÅu middleware, policies, multi‚Äëtenant logic.
  - SPA Frontend: React + Vite, ch·∫°y nh∆∞ SPA (port 5173), giao ti·∫øp v·ªõi Laravel qua API `/api/*` v√† `/api/v1/*`.
  - Realtime: WebSocket server ri√™ng (`simple_websocket_server.php`, `websocket_server.php`, `App\WebSocket\DashboardWebSocketHandler`) nh∆∞ng v·∫´n trong c√πng codebase ‚Üí monolith + realtime sidecar.
- **Stack ch√≠nh**
  - Backend: PHP 8.2, Laravel 10, Sanctum cho API auth, Eloquent ORM, MySQL (CI d√πng MySQL 8, local c√≥ SQLite option).
  - Frontend: React 18, Vite, React Router, React Query, TypeScript, Tailwind, Storybook (build s·∫µn).
  - Testing:
    - PHP: PHPUnit (`tests/Unit`, `tests/Feature`, `tests/Integration`, `tests/Performance`, `tests/Browser`).
    - JS/TS: Vitest (`frontend`), Jest legacy, Playwright E2E (c·∫£ root v√† `frontend`), MSW (`tests/msw`).
  - CI/CD: GitHub Actions (`.github/workflows/*.yml`), Docker (`Dockerfile`, `Dockerfile.prod`, `Dockerfile.websocket`, `docker-compose.yml`), nhi·ªÅu workflow chuy√™n bi·ªát (frontend, e2e, security, openapi).
- **C·∫•u tr√∫c th∆∞ m·ª•c g·ªëc (c·∫•p 1‚Äì2, vai tr√≤)**
  - `app/`: M√£ Laravel ch√≠nh (Controllers, Models, Services, Policies, Middleware, WebSocket).
  - `bootstrap/`, `config/`, `database/`, `resources/`, `routes/`, `storage/`, `public/`: chu·∫©n Laravel.
  - `frontend/`: SPA React/Vite ch√≠nh, ki·∫øn tr√∫c feature‚Äëbased (`features`, `components`, `app`, `shared`).
  - `tests/`: To√†n b·ªô test PHP + E2E orchestration (`tests/e2e`), helpers, fixtures, msw.
  - `.github/workflows/`: CI/CD pipelines (lint, unit, integration, Playwright, security, openapi, deploy).
  - `monitoring/`, `tools/`, `scripts/`, `manage-*.sh`, `monitor-*.sh`: DevOps, monitoring, ti·ªán √≠ch v·∫≠n h√†nh.
  - `docs/`: T√†i li·ªáu chi ti·∫øt (API, DevOps, UI, testing, security, dashboard‚Ä¶).
  - `Dockerfile*`, `docker-compose.yml`: Infra cho local dev, prod, websocket.
  - `src/`: M·ªôt th∆∞ m·ª•c React ph·ª• (`src/components/ui/header/HeaderShell.tsx`, lib kh√°c) ‚Äì likely legacy ho·∫∑c library UI t√°ch ri√™ng.

---

## 2. Ki·∫øn tr√∫c Backend (Laravel)

- **M√¥ h√¨nh ki·∫øn tr√∫c**
  - Layered/service‚Äërepository:
    - Controllers m·ªèng: ƒë·ªãnh tuy·∫øn HTTP, validation, g·ªçi service.
    - Services d√†y: `app/Services/*` l√† l·ªõp business logic, v·ªõi r·∫•t nhi·ªÅu service chuy√™n tr√°ch (TaskService, ProjectService, DashboardService, FeatureFlagService, PermissionService, RateLimitService‚Ä¶).
    - Repositories: `app/Repositories/*` encapsulate truy v·∫•n DB (v√≠ d·ª• `TaskRepository` d√πng trong `TaskService`).
    - Models: `app/Models/*` √°nh x·∫° b·∫£ng domain (Project, Task, Tenant, User, Role, Permission, Dashboard*, Template*, Document*, v.v.).
  - Cross‚Äëcutting concerns qua middleware: security, rate limiting, tenant scope, metrics, observability, error envelope, OpenAPI response validation.
- **Service ch√≠nh, controllers, middleware, policies**
  - Services ti√™u bi·ªÉu (`app/Services`):
    - `TaskService`: x·ª≠ l√Ω t·∫°o/c·∫≠p nh·∫≠t/move/archive task, g·ªçi `TaskStatusTransitionService`, `AuditService`, `PermissionService`, fire events (`task.created`, `task.moved`, `task.archived`).
    - `ProjectService`: qu·∫£n l√Ω project, permissions, logic tr·∫°ng th√°i (xem `ProjectService.php` + tests).
    - `DashboardService`: t·ªïng h·ª£p KPI, recent projects/tasks/activity, alert, d√πng cho API dashboard v√† WebSocket.
    - `FeatureFlagService`: ƒë·ªçc config `features`, cache per tenant/user, override qua `Tenant` v√† `UserPreference`, h·ªó tr·ª£ clear cache.
    - `PermissionService`, `AbilityMatrixService`, `PermissionMatrixService`: x√¢y RBAC/abilities, k·∫øt n·ªëi v·ªõi policies/middleware.
    - `SidebarService`, `NavigationService`: build c·∫•u h√¨nh sidebar/navigation theo role/tenant/feature flags.
    - `PerformanceMonitoringService`, `MetricsService`, `MonitoringService`: metrics, performance, logs.
    - `RateLimitService` / `UnifiedRateLimitMiddleware`: ƒëi·ªÅu ph·ªëi rate limit ƒëa chi·∫øn l∆∞·ª£c.
    - `OutboxService`, `AuditService`, `EmailService`, `InvitationService`, `MFAService`, `OIDCService`‚Ä¶ cung c·∫•p t√≠nh nƒÉng n√¢ng cao.
  - Controllers quan tr·ªçng (`app/Http/Controllers`):
    - `Api\V1\App\DashboardController`: cung c·∫•p API `/api/v1/app/dashboard/*` (summary, KPIs, recent projects/tasks/activity).
    - `Api\Auth\AuthenticationController`: login/logout, session token, response envelope chu·∫©n.
    - `Api\DocumentController`, `Unified\ProjectManagementController`, `PerformanceController`, `Web\ClientController`, v.v.
  - Middleware (`app/Http/Middleware`):
    - B·∫£o m·∫≠t & headers: `SecurityHeadersMiddleware`, `EnhancedSecurityHeadersMiddleware`, `ProductionSecurityMiddleware`, `CorsMiddleware`.
    - Auth & RBAC: `ApiAuthenticationMiddleware`, `RBACMiddleware`, `RoleBasedAccessControlMiddleware`, `AbilityMiddleware`, `CheckPermission`, `RolePermission`, `AdminOnlyMiddleware`, `EnsureAdminAccess`, `EnsureSystemAdmin`.
    - Tenancy: `TenantScopeMiddleware`, `TenantScope`, `TenantIsolationMiddleware`, `TenantAbilityMiddleware`.
    - Observability: `RequestCorrelationMiddleware` (X‚ÄëRequest‚ÄëId), `MetricsMiddleware`, `PerformanceLoggingMiddleware`, `LogSamplingMiddleware`, `ObservabilityMiddleware`, `RequestLoggingMiddleware`, `DatabaseQueryMonitoringMiddleware`, `QueryBudgetMiddleware`, `QueryPerformanceMiddleware`.
    - Security helpers: `BruteForceProtectionMiddleware`, `IdempotencyMiddleware`, `InputSanitizationMiddleware`, `EnhancedValidationMiddleware`, `ValidateApiResponseMiddleware`, `OpenApiResponseValidator`.
    - Unified: `UnifiedRateLimitMiddleware`, `UnifiedSecurityMiddleware`, `UnifiedValidationMiddleware`.
  - Policies (`app/Policies` + `ZenaRole/ZenaPermission` models): policies cho tasks/projects/documents, mapping qua Role/Permission v√† ability matrix.
- **C∆° ch·∫ø multi‚Äëtenant, RBAC, security**
  - Multi‚Äëtenant:
    - `Tenant` model v·ªõi ULID, slug, domain, settings, status.
    - `User` c√≥ `tenant_id` v√† quan h·ªá `tenant()`; h·∫ßu h·∫øt entity (Project, Task, Document‚Ä¶) c√≥ `tenant_id` + global scope (BelongsToTenant ‚Äì m√¥ t·∫£ trong docs v√† middleware).
    - `TenantScopeMiddleware`:
      - L·∫•y `Auth::user()`, n·∫øu kh√¥ng c√≥ ‚Üí b·ªè qua.
      - N·∫øu user l√† super admin (`isSuperAdmin`, `is_admin`, `can('admin.access')`) ‚Üí tenant context = null (truy c·∫≠p m·ªçi tenant).
      - N·∫øu c√≥ `tenant_id` ‚Üí set `app()->instance('current_tenant_id', tenant_id)`, inject v√†o request (`tenant_id`), merge v√†o input, log trong local/testing.
      - Tenant isolation c√≤n ƒë∆∞·ª£c test b·∫±ng scripts/test v√† E2E (xem `test_tenant_isolation.php`, docs `TenantIsolationTest` references).
  - RBAC:
    - Models: `Role`, `Permission`, `RolePermission`, `ZenaRole`, `ZenaPermission`.
    - `User->roles()` many‚Äëto‚Äëmany qua `zena_user_roles` (fix trong model).
    - `User->hasRole($role)`: check field `role` + quan h·ªá `roles`.
    - Ability matrix: `AbilityMatrixService`, `PermissionMatrixService` ƒë·ªçc ma tr·∫≠n ability t·ª´ config/docs.
    - Middleware `AbilityMiddleware`, `RolePermission`, `CheckPermission` map routes ‚Üí abilities.
  - Policies:
    - Policies per domain (TaskPolicy, ProjectPolicy ...) (xem `app/Policies`), k·∫øt h·ª£p v·ªõi Gates v√† `can()` checks trong controllers/services.
  - Security:
    - Auth:
      - Laravel Sanctum (`HasApiTokens` trong `User`) cho API token / SPA auth.
      - `auth:sanctum` d√πng guard chu·∫©n; `auth.sanctum.stateful` cho SPA stateful.
      - Login API: `/api/auth/login` (`AuthenticationController`) tr·∫£ `token`, `session_id`, `expires_in`, `user` data, `onboarding_state`.
      - Logout API: `/api/auth/logout` (Bearer token).
    - CSRF & CORS:
      - `VerifyCsrfToken` trong `web` group, `EnsureFrontendRequestsAreStateful` trong `api` group ƒë·ªÉ h·ªó tr·ª£ SPA.
      - `CorsMiddleware` + config CORS (ki·ªÉm tra `config/cors.php`) v√† custom `CorsService`.
    - Rate limiting:
      - `UnifiedRateLimitMiddleware` l√†m middleware ch√≠nh (replaces nhi·ªÅu middleware c≈©).
      - Strategy: `sliding`, `token_bucket`, `fixed` v·ªõi key d·ª±a tr√™n `user.id` ho·∫∑c IP + route name/path.
      - ƒêi·ªÅu ch·ªânh theo role (admin/member/client) v√† route (auth/login vs admin).
    - Header hardening:
      - `SecurityHeadersMiddleware`, `EnhancedSecurityHeadersMiddleware`, `ProductionSecurityMiddleware`, `SecureSessionMiddleware`, `SecurityHeaders` ‚Äì th√™m HSTS, X‚ÄëFrame‚ÄëOptions, CSP, cookie flags, etc.
    - MFA & OIDC/SAML:
      - `User` c√≥ tr∆∞·ªùng `mfa_enabled`, `oidc_*`, `saml_*`; services `MFAService`, `OIDCService`, `PasswordSecurityService` qu·∫£n l√Ω logic.
    - Error envelope + OpenAPI:
      - Error format chu·∫©n: `{ ok: false, error: { code, message, details?, traceId } }`.
      - `ErrorEnvelopeMiddleware`, `ValidateApiResponseMiddleware`, `OpenApiResponseValidator` d√πng `openapi-security.json` ƒë·ªÉ validate responses (dev/staging).
- **Lu·ªìng x·ª≠ l√Ω API (route ‚Üí controller ‚Üí service ‚Üí model)**
  - V√≠ d·ª• tasks:
    - Route: `routes/api_v1.php` ‚Üí prefix `/api/v1/app/tasks` v·ªõi middleware `api`, `auth:sanctum`, `tenant.scope`, `rate.limit`.
    - Controller: `App\Http\Controllers\Api\V1\App\TaskController` (pattern t∆∞∆°ng t·ª±).
    - Service: `TaskService` d√πng `TaskRepository`, `TaskStatusTransitionService`, `AuditService`, `PermissionService`.
    - Model: `Task` (c√≥ `tenant_id`, `project_id`‚Ä¶), global tenant scope, events, casts.
  - V√≠ d·ª• dashboard:
    - Route: `/api/v1/app/dashboard/*` (doc trong `docs/API_DOCUMENTATION.md`).
    - Controller: `DashboardController` g·ªçi `DashboardService` ƒë·ªÉ aggregate kpis, recent projects/tasks/activity.
    - WebSocket: `DashboardWebSocketHandler` c≈©ng d√πng `DashboardService` ƒë·ªÉ fetch realtime data.
- **Jobs/queue, event/outbox, realtime**
  - Jobs/queue:
    - `app/Jobs/*` (v√≠ d·ª• `SendWelcomeEmailJob`, `SyncJob`), d√πng queue connection config (`QUEUE_CONNECTION`).
    - CI/E2E config ƒë·∫∑t `QUEUE_CONNECTION=sync` cho test.
  - Event/outbox:
    - `Outbox` model + `OutboxService` x·ª≠ l√Ω outbox pattern (persist event r·ªìi process async).
    - `TaskService` dispatch string events (`task.created`, `task.moved`, `task.archived`, `task.updated`) ƒë·ªÉ listeners/observers x·ª≠ l√Ω side effects/audit/logs.
  - Realtime (WebSocket):
    - Handler: `App\WebSocket\DashboardWebSocketHandler` implements `Ratchet\MessageComponentInterface`.
      - Qu·∫£n l√Ω clients, userConnections (map user‚Üíconnections), messageQueues, messageCounts (backpressure), slowConsumers.
      - Message types: `authenticate` (validate token, map connection‚Üíuser), `subscribe`/`unsubscribe` (channels: dashboard metrics, alerts, activity), `ping`.
      - Rate limiting per connection: `getMaxMessagesPerSecond()` t·ª´ config, n·∫øu v∆∞·ª£t ‚Üí send error.
      - On user role change: `User::boot()` updated callback g·ªçi `DashboardWebSocketHandler::revokeUserConnectionsOnRoleChange` ƒë·ªÉ revoke connections theo role.
    - WebSocket server scripts: `websocket_server.php`, `simple_websocket_server.php`, `websocket_test.php.disabled`.

---

## 3. Ki·∫øn tr√∫c Frontend (React/Vite)

- **C·∫•u tr√∫c `frontend/src`**
  - `app/`: shell v√† routing
    - `router.tsx`: `createBrowserRouter`, lazy‚Äëload routes theo feature.
    - `layouts/MainLayout`, `layouts/AdminLayout`.
    - `guards/AuthGuard`, `AdminGuard`.
    - `providers` (Auth/Theme/Query) ‚Äì xem th√™m trong folder.
  - `features/`: feature‚Äësliced architecture
    - `auth/`: pages Login/Register/Forgot/Reset, hooks, api, forms.
    - `dashboard/`: `DashboardPage`, widgets, hooks, api; `AdminDashboardPage`.
    - `projects/`, `tasks/`, `documents/`, `change-requests/`, `clients/`, `quotes/`, `qc/`, `reports/`, `settings/`, `users/`‚Ä¶ m·ªói feature c√≥ `pages/`, `components/`, `hooks.ts`, `api.ts`, `types.ts`.
    - `_archived/`: code c≈© (templates v.v.) ƒë∆∞·ª£c gi·ªØ ƒë·ªÉ reference.
  - `components/`:
    - `layout/HeaderShell.tsx`: Apple‚Äëstyle header, d√πng `ThemeProvider`, `SmartSearch`, fetch `/api/v1/app/search`, hi·ªÉn th·ªã search results (project/task/user/document).
    - `dashboard/*`: AlertBanner, KPI strips, widgets.
    - Shared UI primitives: buttons, tables, forms‚Ä¶
  - `shared/`:
    - `api/client.ts`: Axios client chu·∫©n v·ªõi interceptors, error mapping, headers (tenant, auth, CSRF).
    - `tokens/colors.ts`, theme system, utilities chung.
  - `hooks/`: hooks generic.
  - `pages/errors/`: `NotFoundPage`, `ServerErrorPage`.
  - `index.css`, `main.tsx`: bootstrap React app.
- **State management, routing, auth, i18n, UI**
  - State:
    - Server state: React Query (`@tanstack/react-query`) l√† tr·ª•c ch√≠nh cho data fetching & caching (v√≠ d·ª• `features/tasks/hooks.ts`).
    - Local UI state: React state + context; c√≥ th·ªÉ c√≥ Zustand ho·∫∑c similar trong `stores` (auth store trong open tabs, path c√≥ th·ªÉ thay ƒë·ªïi).
  - Routing:
    - `createBrowserRouter` v·ªõi nested routes:
      - `/login`, `/register`, `/forgot-password`, `/reset-password`, `/invite/:token` (auth routes).
      - `/app/*` d∆∞·ªõi `AuthGuard` + `MainLayout`:
        - `/app/dashboard`
        - `/app/projects`, `/app/projects/:id`, `/app/projects/create`, `/app/projects/:id/edit`
        - `/app/tasks`, `/app/tasks/kanban`, `/app/tasks/:id`, `/app/tasks/create`, `/app/tasks/:id/edit`
        - `/app/clients`, `/app/quotes`, `/app/documents`, `/app/reports`, etc.
      - `/admin/*` d∆∞·ªõi `AdminGuard` + `AdminLayout` (users, templates, admin dashboard‚Ä¶).
  - Auth:
    - Auth guard ƒë·ªçc tr·∫°ng th√°i user (token/session) t·ª´ auth context/store.
    - Login page g·ªçi API `/api/auth/login` qua shared API client, l∆∞u token (localStorage/cookie), router redirect `/app/dashboard`.
    - Logout g·ªçi `/api/auth/logout`, clear state, redirect `/login`.
  - i18n:
    - `Accept-Language` header set t·ª´ `readLocale()` (·ªü `shared/api/client.ts`), ph√≠a server d√πng `SetLocaleMiddleware`.
  - UI system:
    - Apple‚Äëstyle header (`HeaderShell`), KPI strip component, layout shell, responsive design.
    - Design tokens (`colors.ts`), theme provider (`ThemeProvider`), `data-theme` tr√™n document.
    - Component library ƒë∆∞·ª£c catalog trong docs (`ComponentLibraryGuide.md`, `component-inventory.md`).
- **Giao ti·∫øp API, error/loading, caching, optimistic update**
  - API client (`frontend/src/shared/api/client.ts`):
    - `createApiClient()` t·∫°o Axios instance v·ªõi base URL `/api` (Vite proxy ‚Üí Laravel).
    - Request interceptor:
      - G·∫Øn `Authorization`:
        - N·∫øu browser: ƒë·ªçc token t·ª´ `localStorage` theo key chu·∫©n (auth store).
        - N·∫øu SSR/test: d√πng `authToken` param n·∫øu c√≥.
      - G·∫Øn `X-Tenant-ID` t·ª´ `readTenantId()`.
      - G·∫Øn `X-CSRF-TOKEN` t·ª´ cookie/meta.
      - G·∫Øn `X-Request-ID`, `Accept-Language`, `X-Frontend-Theme`.
    - Response error mapper (`mapAxiosError`):
      - ∆Øu ti√™n error envelope chu·∫©n `{ ok: false, error: {...} }`.
      - H·ªó tr·ª£ legacy `{ message, error: { message, code }, errors }`.
      - Lu√¥n √°nh x·∫° th√†nh `ApiError` v·ªõi `status`, `code`, `details`, `traceId`.
  - Feature API (v√≠ d·ª• `features/tasks/api.ts` ho·∫∑c `frontend/src/entities/tasks/api.ts`):
    - ƒê·ªãnh nghƒ©a types (`Task`, `TaskFilters`, `TasksResponse`).
    - Endpoints: `getTasks`, `getTask`, `createTask`, `updateTask`, `moveTask`, `deleteTask`, `getKpis`, `getAlerts`, `getActivity`, bulk actions.
    - D√πng `mapAxiosError` ƒë·ªÉ normalize l·ªói.
  - Hooks (`features/tasks/hooks.ts` ho·∫∑c `frontend/src/entities/tasks/hooks.ts`):
    - `useTasks`, `useTask`, `useTasksKpis`, `useTasksAlerts`, `useTasksActivity`: `useQuery` v·ªõi `queryKey` chu·∫©n, `staleTime`/`cacheTime` t·ªëi ∆∞u theo lo·∫°i data.
    - Mutations: `useCreateTask`, `useUpdateTask`, `useDeleteTask`, `useBulk*`:
      - `onSuccess` ‚Üí `invalidateQueries` cho c√°c key li√™n quan (`['tasks']`, `['task', id]`, `['tasks','kpis']`).
      - Optimistic update c√≥ th·ªÉ ƒë∆∞·ª£c x·ª≠ l√Ω t·∫°i component level (hook note trong update).
- **Patterns quan tr·ªçng**
  - Feature‚Äësliced architecture: m·ªói feature c√≥ `api.ts`, `hooks.ts`, `types.ts`, `pages/`, `components/`.
  - Layout shell: `MainLayout`, `AdminLayout`, `HeaderShell` t·∫°o skeletal layout chu·∫©n cho to√†n app.
  - Error envelope pattern (FE/BE c√πng hi·ªÉu): m·ªçi API error ƒë∆∞·ª£c chu·∫©n h√≥a ƒë·ªÉ UI x·ª≠ l√Ω th·ªëng nh·∫•t.
  - Strong typing: Typescript cho components/features, tr√°nh any trong API layer.

---

## 4. Multi‚ÄëTenancy & Security (end‚Äëto‚Äëend)

- **C√°ch x√°c ƒë·ªãnh tenant trong request**
  - Server:
    - `Auth::user()->tenant_id` l√† ngu·ªìn ch√≠nh.
    - `TenantScopeMiddleware` d√πng `Auth::user()`:
      - N·∫øu super admin: `current_tenant_id = null`.
      - Ng∆∞·ª£c l·∫°i: set `current_tenant_id` + merge `tenant_id` v√†o request.
    - Models √°p d·ª•ng Global Scope `BelongsToTenant` (m√¥ t·∫£ trong docs) ƒë·ªÉ auto‚Äëfilter `tenant_id`.
  - Client:
    - `X-Tenant-ID` header t·ª´ `readTenantId()` (persisted trong client store ho·∫∑c derive t·ª´ user profile).
- **R√†ng bu·ªôc tenant trong DB, middleware, service, test**
  - DB:
    - H·∫ßu h·∫øt b·∫£ng domain c√≥ `tenant_id` (Project, Task, Document, Template, SidebarConfig, Notification, etc.).
    - Tests & migrations ƒë·∫∑c bi·ªát: `2025_10_25_100000_create_policy_test_tables.php` thi·∫øt l·∫≠p b·∫£ng test policies; `test_tenant_isolation.php` script ƒë·ªÉ verify DB isolation; `TenantIsolationTest.php` trong `tests/Feature`.
  - Middleware:
    - `TenantScopeMiddleware`, `TenantScope`, `TenantIsolationMiddleware` ƒë·ªÉ enforce scoping tr√™n queries.
    - `TenantAbilityMiddleware` k·∫øt h·ª£p RBAC + tenancy (user ch·ªâ c√≥ ability trong tenant c·ªßa m√¨nh).
  - Services:
    - Service method signature th∆∞·ªùng nh·∫≠n `tenantId` explicit:
      - V√≠ d·ª• `TaskService::createTask(array $data, string $userId, string $tenantId)`.
      - Repositories nh·∫≠n `tenantId` khi `getById` / `update`, etc.
  - Tests:
    - Feature/Auth: `AuthenticationModuleTest` seed tenant v√† user theo domain seed, ƒë·∫£m b·∫£o login/logout g·∫Øn v·ªõi tenant ƒë√∫ng.
    - E2E helpers: `tests/e2e/setup/global-setup.ts` build env, migrate DB, seed test data domain, storage isolation; domain seeds drive deterministic tenants.
- **C·∫•u tr√∫c RBAC (Role, Permission, Policy, Ability)**
  - Role models: `Role`, `ZenaRole`, `UserRole`, `UserRoleSystem`, `UserRoleProject`.
  - Permission models: `Permission`, `RolePermission`, `ZenaPermission`.
  - Ability & matrix:
    - `AbilityMatrixService`, `PermissionMatrixService` ƒë·ªçc ma tr·∫≠n ability t·ª´ config/docs.
    - Middleware `AbilityMiddleware`, `RolePermission`, `CheckPermission` map routes ‚Üí abilities.
  - Policies:
    - Policies per domain (TaskPolicy, ProjectPolicy ...) (xem `app/Policies`), k·∫øt h·ª£p v·ªõi Gates v√† `can()` checks trong controllers/services.
- **C∆° ch·∫ø b·∫£o m·∫≠t**
  - Auth:
    - Sanctum tokens, session‚Äëbased login (web) + token‚Äëbased (API).
    - `AuthenticationController` unify login/logout APIs, consistent response envelope.
    - API login route: `/api/auth/login` (web middleware `throttle:login`).
  - CORS & CSRF:
    - `HandleCors` global, `CorsMiddleware` custom.
    - `VerifyCsrfToken` trong `web` group, SPA CSRF cookie endpoint `/api/v1/auth/csrf-cookie`.
  - Rate limit:
    - `UnifiedRateLimitMiddleware` cho API routes, custom strategies & per‚Äërole tuning; dedicated `ProjectsRateLimiter` etc. cho m·ªôt s·ªë routes.
  - MFA/OIDC/SAML:
    - `User` c√≥ nhi·ªÅu field security (MFA, OIDC, SAML), service t∆∞∆°ng ·ª©ng ƒë·ªÉ t√≠ch h·ª£p v·ªõi IdP.
  - Header hardening:
    - `SecurityHeadersMiddleware`, `EnhancedSecurityHeadersMiddleware`, `ProductionSecurityMiddleware`, `SecureSessionMiddleware`, `SecurityHeaders` ‚Äì th√™m/si·∫øt headers, cookie flags, session protections.
  - Additional:
    - `BruteForceProtectionMiddleware` b·∫£o v·ªá login endpoints.
    - `IdempotencyMiddleware` ch·ªëng double‚Äësubmit (idempotency key model).
    - `AdvancedSecurityMiddleware`, `AdvancedSecurityService`, `SecurityRule`, `SecurityAlert` models.
    - Security tests: `SecurityIntegrationTest.php`, `openapi-security.json`, `postman-security-collection.json`, workflows `security-audit.yml`, `openapi-*`.

---

## 5. Testing & Quality

- **Nh√≥m test ch√≠nh**
  - PHP:
    - `tests/Unit`: unit tests cho services, repositories, controllers (v√≠ d·ª• `TaskServiceTest.php`, `ProjectServiceTest.php`, `FeatureFlagServiceTest.php`).
    - `tests/Feature`: feature/API tests (v√≠ d·ª• `ApiEndpointsTest.php`, `ProjectApiTest.php`, `DocumentApiTest.php`, `TasksContractTest.php`, `MoveTaskEndpointTest.php`, Auth tests).
    - `tests/Integration`: integration tests (tenant isolation, sync jobs, security, rate limit, status sync‚Ä¶).
    - `tests/Performance`: performance tests / budgets.
    - `tests/Browser`: Dusk/Browser tests (legacy).
  - JS/TS:
    - Vitest: `frontend/vitest.config.ts` ‚Äì ch·∫°y `src/**/*.{test,spec}.{ts,tsx}` v√† `__tests__/**`.
      - Test UI & logic: `HeaderShell.test.tsx`, `LoginPage.test.tsx`, tasks hooks/utils tests (`errorExplanation.test.ts`, `useTaskTransitionValidation.test.ts`).
    - Jest: `frontend/jest.config.js` (legacy compat).
    - Playwright:
      - Root `tests/E2E/*`: nhi·ªÅu suites ‚Äì `dashboard`, `auth`, `core`, `smoke`, `regression`, `header`, `phase3`, `template-apply`, v.v.
      - `tests/E2E/dashboard/Dashboard.spec.ts`: ki·ªÉm tra dashboard layout, KPI strip, header, responsiveness, notifications API kh√¥ng 404, performance budget (<3s).
      - `tests/E2E/smoke/*`: smoke flows (auth, project create, alerts, minimal flows).
- **Coverage ∆∞·ªõc t√≠nh & test quan tr·ªçng**
  - Backend:
    - Bao ph·ªß services ch√≠nh (Task/Project/FeatureFlag/RateLimit/Auth), contract tests (TasksContractTest, ProjectApiTest, DocumentApiTest), policies (PolicyTest), tenant isolation (TenantIsolationTest), sync jobs (TaskStatusSyncTest).
  - E2E:
    - Flows ch√≠nh (login, dashboard, projects, tasks, templates), header/navigation consistency, error handling, performance budgets (dashboard load time, layout shift).
  - Security:
    - `SecurityIntegrationTest`, openapi validation workflows, security audit (npm/composer) ch·∫°y ƒë·ªãnh k·ª≥.
- **C√¥ng c·ª• test FE/BE**
  - Backend:
    - PHPUnit (`phpunit.xml`, `phpunit.dusk.xml`).
    - Laravel test helpers, domain seeder (`Tests\Helpers\TestDataSeeder`), traits (`DomainTestIsolation`, etc.).
  - Frontend:
    - Vitest (unit/component).
    - Playwright (`frontend/playwright.config.ts`, root `playwright.config.ts`, `playwright.phase3.config.ts`).
    - MSW (`tests/msw/handlers/tasks.ts`, `tests/msw/fixtures/tasks.json`) d√πng cho contract tests/mocks.
- **Fixtures, mocks, CI test pipeline**
  - Fixtures:
    - `tests/fixtures`, `tests/msw/fixtures`, E2E env `.env.e2e`, DB seeds (TestUsersSeeder, TestDataSeeder).
  - E2E setup:
    - `tests/e2e/setup/global-setup.ts`:
      - Parse `.env` + `.env.e2e`.
      - Chu·∫©n b·ªã storage dirs, t·∫°o symlink `public/storage`.
      - Ch·∫°y `php artisan migrate` + seed data.
      - Set `DB_CONNECTION`/`DB_DATABASE` tu·ª≥ env (SQLite local, MySQL CI).
      - Apply crypto polyfill cho Node `crypto.randomUUID/getRandomValues`.
  - CI pipeline:
    - `ci-cd.yml`:
      - Jobs: `security-audit`, `code-quality`, `backend-tests`.
      - `backend-tests`: spin MySQL service, run migrations/seeders, ch·∫°y Feature + Unit suites, upload test results.
    - C√°c workflow kh√°c:
      - `frontend-ci.yml`: lint + build + tests (Vitest).
      - `playwright-core.yml`, `playwright-regression.yml`, `e2e-smoke.yml`, `e2e-auth.yml`: orchestrate E2E v·ªõi dependency chain (PHP unit tests tr∆∞·ªõc).
      - `openapi-check.yml`, `openapi-contract-test.yml`, `openapi-validation.yml` cho contract & schema compliance.
      - `code-quality-security.yml`, `security-audit.yml` cho security/lint.

---

## 6. DevOps, CI/CD, Monitoring

- **Quy tr√¨nh build/deploy**
  - Docker:
    - `Dockerfile`: base dev image (PHP + Node + extensions).
    - `Dockerfile.prod`: prod image build (optimized, no dev deps).
    - `Dockerfile.websocket`: dedicated image cho WebSocket server.
    - `docker-compose.yml`: orchestration Laravel + DB + WebSocket + frontend proxy.
  - Deployment:
    - Workflows: `deploy.yml`, `automated-deployment.yml`, `production.yml`, `release-management.yml`.
    - Scripts: `setup-cicd.sh`, `setup_frontend.sh`, `quick-setup-domain.sh`, `setup-domain-manager.sh`, `setup-https-domain.sh`, `setup-ssl.sh`, `rollback-production.sh`.
    - Domain/HTTPS: `Domain` instructions + `DEVOPS_PIPELINE_DOCUMENTATION.md`, `PRODUCTION_DEPLOYMENT_CHECKLIST.md`, `üöÄ_FINAL_STEPS_HTTPS.md`.
- **Pipeline stages (theo docs/DEVOPS_PIPELINE_DOCUMENTATION.md)**
  1. Code Quality: lint, formatting, static analysis.
  2. Unit Testing: PHP Unit test suites.
  3. Integration Testing: API/DB integration tests.
  4. E2E Testing: Playwright core/regression/smoke.
  5. Security Testing: Vulnerability scanning, security tests, openapi security.
  6. Performance Testing: Load/performance validation v√† budgets (`performance-budgets.json`).
  7. Deployment: staging/prod deploy jobs.
  8. Monitoring: health checks v√† performance monitoring.
- **Monitoring/logging**
  - Metrics endpoints:
    - `/api/health` + `/api/metrics/*` (xem `routes/api.php`, `MetricsController`).
    - Detailed performance health: `/api/health/performance`.
  - Services:
    - `MetricsService`, `MetricsCollector`, `MetricsCollectionService`, `PerformanceMonitoringService`, `MonitoringService`, `PerformanceAlertingService`.
    - `InteractionLogService/QueryLog/PerformanceMetric` models.
  - Middleware:
    - `MetricsMiddleware`, `PerformanceLoggingMiddleware`, `RequestCorrelationMiddleware`, `LogSamplingMiddleware`, `ObservabilityMiddleware`, `DatabaseQueryMonitoringMiddleware`, `QueryBudgetMiddleware`.
  - Scripts & docs v·∫≠n h√†nh:
    - `monitor-performance.sh`, `monitor-production.sh`, `monitoring/` configs.
    - `CI_CD_MONITORING_GUIDE.md`, `DEVOPS_PIPELINE_DOCUMENTATION.md`, `PERFORMANCE_*`, `API_DOCUMENTATION.md`, `DASHBOARD_*` reports.
    - `test-views.sh`, `test-api-endpoints.sh`, `test_csrf_cors_session.php`, `test_idempotency.php`, `test_tenant_isolation.php`.

---

## 7. ƒê√°nh gi√° t·ªïng h·ª£p

- **ƒêi·ªÉm m·∫°nh / best practices**
  - R√µ r√†ng ph√¢n t·∫ßng backend: routes ‚Üí controllers ‚Üí services ‚Üí repositories ‚Üí models; services chuy√™n bi·ªát, d·ªÖ t√°i s·ª≠ d·ª•ng.
  - Multi‚Äëtenancy ƒë∆∞·ª£c x·ª≠ l√Ω b√†i b·∫£n:
    - Tenant ID ƒë∆∞·ª£c propagate qua middleware + global scope + headers t·ª´ frontend.
    - Tests ri√™ng cho tenant isolation + domain‚Äëbased seeds.
  - RBAC & Ability matrix t∆∞∆°ng ƒë·ªëi phong ph√∫:
    - Separation gi·ªØa Role/Permission v√† Policies; middleware ability‚Äëbased; matrix services.
  - B·∫£o m·∫≠t kh√° s√¢u:
    - Sanctum, CSRF, CORS, rate limit ƒëa chi·∫øn l∆∞·ª£c, brute‚Äëforce protection, idempotency, MFA/OIDC/SAML hooks.
    - Security headers, OpenAPI response validation, security integration tests, npm/composer audit trong CI.
  - Observability & Monitoring:
    - Correlation ID, metrics middleware, query budget, performance metrics, dedicated monitoring scripts & docs.
  - Frontend hi·ªán ƒë·∫°i:
    - Feature‚Äësliced React, React Query, TypeScript, normalized error envelope, theme system, well‚Äëstructured routing.
  - Testing & CI/CD ƒë·∫ßy ƒë·ªß:
    - Unit + Feature + Integration + E2E (Playwright) + Performance + Security.
    - Pipelines v·ªõi dependency chain r√µ r√†ng (PHP unit ‚Üí Playwright), caching, scheduled runs.
- **R·ªßi ro / n·ª£ k·ªπ thu·∫≠t ti·ªÅm ·∫©n**
  - S·ªë l∆∞·ª£ng service & middleware r·∫•t l·ªõn:
    - Nguy c∆° tr√πng ch·ª©c nƒÉng (nhi·ªÅu `*Security*`, `*RateLimit*`, `*Logging*` services/middleware; m·ªôt s·ªë file `.disabled`).
    - TƒÉng ƒë·ªô ph·ª©c t·∫°p khi debug ‚Äì c·∫ßn chu·∫©n h√≥a ‚Äúsingle source of truth‚Äù cho c√°c concerns cross‚Äëcutting.
  - Hai ‚Äúth·∫ø gi·ªõi‚Äù frontend (Laravel Blade vs React SPA):
    - ƒê√£ c·ªë g·∫Øng chu·∫©n h√≥a ‚ÄúAPI only‚Äù trong `routes/api.php` v√† disable Blade auth routes, nh∆∞ng v·∫´n c√≤n Blade views (layouts/app, admin, app dashboards) ‚Üí nguy c∆° divergence UI/behaviour.
  - WebSocket security:
    - Handler c√≥ rate limit v√† role revocation, nh∆∞ng token validation, tenant/rbac checks trong WebSocket c√≤n ph·ª• thu·ªôc v√†o implementation c·ªßa `authenticateUser()` (c·∫ßn audit chi ti·∫øt).
  - Cache invalidation:
    - Feature flags, KPI cache, dashboard widgets, tasks kpis ‚Äì nhi·ªÅu n∆°i d√πng cache; c·∫ßn ƒë·∫£m b·∫£o invalidation th·ªëng nh·∫•t ƒë·ªÉ tr√°nh stale data.
  - OpenAPI & Error envelope:
    - Hi·ªán ƒë√£ c√≥ `openapi-security.json` + `OpenApiResponseValidator`, nh∆∞ng c·∫ßn ƒë·∫£m b·∫£o t·∫•t c·∫£ endpoints m·ªõi tu√¢n th·ªß spec v√† error envelope (tr√°nh legacy format).
- **G·ª£i √Ω ƒëi·ªÉm n√™n nghi√™n c·ª©u s√¢u h∆°n cho GPT‚Äë5**
  - **OpenAPI & contracts**:
    - ƒê√†o s√¢u `openapi-security.json`, c√°c workflow `openapi-*.yml`, `API_DOCUMENTATION.md` ƒë·ªÉ n·∫Øm to√†n b·ªô surface API & error envelope ch√≠nh x√°c.
  - **Error envelope standard**:
    - Chu·∫©n h√≥a c·∫£ ph√≠a backend (middleware, exception handler) & frontend (mapAxiosError, UI error components), ƒë·∫£m b·∫£o m·ªçi endpoint d√πng 1 format duy nh·∫•t.
  - **Outbox & async processing**:
    - Xem `OutboxService`, `Outbox` model, jobs, event listeners ƒë·ªÉ hi·ªÉu c∆° ch·∫ø cross‚Äësystem integration v√† idempotency.
  - **Tenant isolation & RBAC enforcement**:
    - Review chi ti·∫øt `TenantScope` global scope, `TenantIsolationMiddleware`, ability matrix docs, v√† tests li√™n quan (`PolicyTest`, tenant isolation scripts).
  - **WebSocket auth & multi‚Äëtenant security**:
    - Audit `DashboardWebSocketHandler::authenticateUser`, subscription model, mapping user‚Üítenant‚Üíchannels; ƒë·∫£m b·∫£o constraints gi·ªëng REST API.
  - **CI/CD & performance budgets**:
    - Ph√¢n t√≠ch `performance-budgets.json`, `Dashboard Performance` tests, monitoring scripts ƒë·ªÉ hi·ªÉu SLAs/SLOs hi·ªán d√πng v√† c√°ch pipeline enforce.

