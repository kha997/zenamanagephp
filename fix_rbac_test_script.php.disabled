<?php declare(strict_types=1);

/**
 * Script sá»­a lá»—i cÃº phÃ¡p trong test_rbac_middleware_basic.php
 */

echo "ğŸ”§ Sá»­a lá»—i cÃº phÃ¡p trong test_rbac_middleware_basic.php...\n\n";

$filePath = __DIR__ . '/test_rbac_middleware_basic.php';

// Ná»™i dung file Ä‘Ã£ sá»­a lá»—i
$fixedContent = <<<'PHP'
<?php declare(strict_types=1);

/**
 * Script test chá»©c nÄƒng cÆ¡ báº£n cá»§a RBAC middleware
 * Táº¡o route test Ä‘Æ¡n giáº£n vÃ  kiá»ƒm tra RBAC hoáº¡t Ä‘á»™ng
 */

require_once __DIR__ . '/bootstrap.php';

echo "ğŸ§ª Test chá»©c nÄƒng cÆ¡ báº£n RBAC middleware...\n\n";

try {
    // Äoáº¡n route test dÃ¹ng FQCN (khÃ´ng cáº§n use), cÃ³ prefix v1, guard api, vÃ  nullsafe cho user
    $testRouteContent = <<<'ROUTE'

// Test route cho RBAC middleware
\Illuminate\Support\Facades\Route::prefix('v1')
    ->middleware(['auth:api', 'rbac:project.view'])
    ->get('rbac-test', function (\Illuminate\Http\Request $request) {
        return response()->json([
            'status' => 'success',
            'message' => 'RBAC middleware hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng!',
            'user_id' => $request->user('api')?->id,
            'permissions' => $request->get('user_permissions', []),
            'timestamp' => now()->toIso8601String(),
        ]);
    });
ROUTE;

    // Äá»c file routes/api.php hiá»‡n táº¡i
    $apiRoutesPath = __DIR__ . '/routes/api.php';
    $currentContent = file_get_contents($apiRoutesPath);

    // Backup file gá»‘c
    $backupPath = $apiRoutesPath . '.backup_rbac_test_' . date('Y-m-d_H-i-s');
    file_put_contents($backupPath, $currentContent);
    echo "ğŸ“ ÄÃ£ backup routes/api.php -> {$backupPath}\n";

    // ThÃªm test route vÃ o cuá»‘i file (trÆ°á»›c dáº¥u ?> náº¿u cÃ³)
    $newContent = rtrim($currentContent);
    if (substr($newContent, -2) === '?>') {
        $newContent = substr($newContent, 0, -2) . "\n" . $testRouteContent . "\n?>";
    } else {
        $newContent .= "\n" . $testRouteContent . "\n";
    }

    file_put_contents($apiRoutesPath, $newContent);
    echo "âœ… ÄÃ£ thÃªm test route vÃ o routes/api.php\n";

    // Clear route cache
    echo "\nğŸ”„ Clearing route cache...\n";
    $cmd = 'cd ' . escapeshellarg(__DIR__) . ' && php artisan route:clear 2>&1';
    exec($cmd, $output, $returnCode);

    if ($returnCode === 0) {
        echo "âœ… Route cache cleared successfully\n";
    } else {
        echo "âš ï¸  Route cache clear warning:\n" . implode("\n", $output) . "\n";
    }

    echo "\nğŸ“‹ HÆ°á»›ng dáº«n test:\n";
    echo "1) Táº¡o JWT token cho user cÃ³ quyá»n project.view\n";
    echo "2) Gá»i: GET /api/v1/rbac-test vá»›i header Authorization: Bearer <token>\n";
    echo "3) Response sáº½ chá»©a user_id, permissions\n";

    echo "\nğŸ”§ Lá»‡nh test máº«u:\n";
    echo "curl -X GET http://localhost/zenamanage/public/api/v1/rbac-test \\\n";
    echo "  -H 'Authorization: Bearer YOUR_JWT_TOKEN' \\\n";
    echo "  -H 'Content-Type: application/json'\n";

    echo "\nğŸ—‘ï¸  XÃ³a test route khi xong:\n";
    echo "cp {$backupPath} {$apiRoutesPath} && php artisan route:clear\n";

} catch (Exception $e) {
    echo "âŒ Lá»—i khi táº¡o test route: " . $e->getMessage() . "\n";
    echo "ğŸ“ File: " . $e->getFile() . " (dÃ²ng " . $e->getLine() . ")\n";
    exit(1);
}

echo "\nâœ… Script hoÃ n thÃ nh thÃ nh cÃ´ng!\n";
PHP;

// Backup file cÅ©
$backupPath = $filePath . '.backup_' . date('Y-m-d_H-i-s');
if (file_exists($filePath)) {
    copy($filePath, $backupPath);
    echo "ğŸ“ ÄÃ£ backup file cÅ© -> {$backupPath}\n";
}

// Ghi file má»›i Ä‘Ã£ sá»­a lá»—i
file_put_contents($filePath, $fixedContent);
echo "âœ… ÄÃ£ sá»­a lá»—i cÃº phÃ¡p trong test_rbac_middleware_basic.php\n";
echo "ğŸ”§ BÃ¢y giá» báº¡n cÃ³ thá»ƒ cháº¡y: php test_rbac_middleware_basic.php\n";