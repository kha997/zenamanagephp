{
  "openapi": "3.0.3",
  "info": {
    "title": "ZenaManage Security Center API",
    "description": "API for Super Admin Security Center with real-time monitoring, KPI dashboards, audit logs, and WebSocket broadcasting",
    "version": "1.0.0",
    "contact": {
      "name": "ZenaManage Team",
      "email": "admin@zenamanage.com"
    }
  },
  "servers": [
    {
      "url": "http://localhost:8000",
      "description": "Development server"
    },
    {
      "url": "https://api.zenamanage.com",
      "description": "Production server"
    }
  ],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "paths": {
    "/api/admin/security/kpis": {
      "get": {
        "summary": "Get security KPIs with historical data",
        "description": "Retrieve security KPIs including MFA adoption, failed logins, locked accounts, active sessions, and risky keys with historical series data",
        "tags": ["Security KPIs"],
        "parameters": [
          {
            "name": "period",
            "in": "query",
            "description": "Time period for historical data",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["7d", "30d", "90d"],
              "default": "30d"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Security KPIs retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SecurityKPIsResponse"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "$ref": "#/components/responses/ForbiddenError"
          },
          "422": {
            "$ref": "#/components/responses/ValidationError"
          },
          "304": {
            "$ref": "#/components/responses/NotModified"
          }
        }
      }
    },
    "/api/admin/security/mfa": {
      "get": {
        "summary": "Get MFA users list",
        "description": "Retrieve paginated list of users with MFA status and filtering options",
        "tags": ["MFA Management"],
        "parameters": [
          {
            "name": "per_page",
            "in": "query",
            "description": "Number of items per page",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100,
              "default": 20
            }
          },
          {
            "name": "page",
            "in": "query",
            "description": "Page number",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          },
          {
            "name": "sort_by",
            "in": "query",
            "description": "Field to sort by",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["last_login_at", "created_at", "name", "email"],
              "default": "last_login_at"
            }
          },
          {
            "name": "sort_order",
            "in": "query",
            "description": "Sort order",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["asc", "desc"],
              "default": "desc"
            }
          },
          {
            "name": "mfa_enabled",
            "in": "query",
            "description": "Filter by MFA status",
            "required": false,
            "schema": {
              "type": "boolean"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "MFA users retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MfaUsersResponse"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "$ref": "#/components/responses/ForbiddenError"
          },
          "422": {
            "$ref": "#/components/responses/ValidationError"
          },
          "304": {
            "$ref": "#/components/responses/NotModified"
          }
        }
      }
    },
    "/api/admin/security/logins": {
      "get": {
        "summary": "Get login attempts",
        "description": "Retrieve paginated list of login attempts with filtering options",
        "tags": ["Login Monitoring"],
        "parameters": [
          {
            "name": "per_page",
            "in": "query",
            "description": "Number of items per page",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100,
              "default": 20
            }
          },
          {
            "name": "page",
            "in": "query",
            "description": "Page number",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          },
          {
            "name": "result",
            "in": "query",
            "description": "Filter by login result",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["success", "failed"]
            }
          },
          {
            "name": "date_from",
            "in": "query",
            "description": "Start date (ISO 8601)",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          },
          {
            "name": "date_to",
            "in": "query",
            "description": "End date (ISO 8601)",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Login attempts retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LoginAttemptsResponse"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "$ref": "#/components/responses/ForbiddenError"
          },
          "422": {
            "$ref": "#/components/responses/ValidationError"
          },
          "304": {
            "$ref": "#/components/responses/NotModified"
          }
        }
      }
    },
    "/api/admin/security/audit": {
      "get": {
        "summary": "Get audit logs",
        "description": "Retrieve paginated list of audit logs with filtering and severity mapping",
        "tags": ["Audit Logs"],
        "parameters": [
          {
            "name": "per_page",
            "in": "query",
            "description": "Number of items per page",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100,
              "default": 20
            }
          },
          {
            "name": "page",
            "in": "query",
            "description": "Page number",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          },
          {
            "name": "action",
            "in": "query",
            "description": "Filter by action type",
            "required": false,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "severity",
            "in": "query",
            "description": "Filter by severity level",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["high", "medium", "low", "info"]
            }
          },
          {
            "name": "date_from",
            "in": "query",
            "description": "Start date (ISO 8601)",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          },
          {
            "name": "date_to",
            "in": "query",
            "description": "End date (ISO 8601)",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Audit logs retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuditLogsResponse"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "$ref": "#/components/responses/ForbiddenError"
          },
          "422": {
            "$ref": "#/components/responses/ValidationError"
          },
          "304": {
            "$ref": "#/components/responses/NotModified"
          }
        }
      }
    },
    "/api/admin/security/sessions": {
      "get": {
        "summary": "Get active sessions",
        "description": "Retrieve paginated list of active user sessions",
        "tags": ["Session Management"],
        "parameters": [
          {
            "name": "per_page",
            "in": "query",
            "description": "Number of items per page",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100,
              "default": 20
            }
          },
          {
            "name": "page",
            "in": "query",
            "description": "Page number",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            }
          },
          {
            "name": "active_only",
            "in": "query",
            "description": "Filter only active sessions",
            "required": false,
            "schema": {
              "type": "boolean",
              "default": true
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Active sessions retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ActiveSessionsResponse"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "$ref": "#/components/responses/ForbiddenError"
          },
          "422": {
            "$ref": "#/components/responses/ValidationError"
          },
          "304": {
            "$ref": "#/components/responses/NotModified"
          }
        }
      }
    },
    "/api/admin/security/users/{id}:force-mfa": {
      "post": {
        "summary": "Force MFA for user",
        "description": "Force a user to enable MFA on next login",
        "tags": ["MFA Management"],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "User ID",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "MFA forced successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ForceMfaResponse"
                }
              }
            }
          },
          "404": {
            "$ref": "#/components/responses/NotFoundError"
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "$ref": "#/components/responses/ForbiddenError"
          },
          "422": {
            "$ref": "#/components/responses/ValidationError"
          },
          "304": {
            "$ref": "#/components/responses/NotModified"
          }
        }
      }
    },
    "/api/admin/security/audit/export": {
      "get": {
        "summary": "Export audit logs to CSV",
        "description": "Export audit logs to CSV format with rate limiting",
        "tags": ["Export"],
        "parameters": [
          {
            "name": "action",
            "in": "query",
            "description": "Filter by action type",
            "required": false,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "severity",
            "in": "query",
            "description": "Filter by severity level",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["high", "medium", "low", "info"]
            }
          },
          {
            "name": "date_from",
            "in": "query",
            "description": "Start date (ISO 8601)",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          },
          {
            "name": "date_to",
            "in": "query",
            "description": "End date (ISO 8601)",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "CSV file downloaded successfully",
            "content": {
              "text/csv": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              }
            },
            "headers": {
              "Content-Disposition": {
                "description": "Attachment filename",
                "schema": {
                  "type": "string"
                }
              }
            }
          },
          "429": {
            "description": "Rate limit exceeded",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RateLimitError"
                }
              }
            },
            "headers": {
              "Retry-After": {
                "description": "Seconds to wait before retrying",
                "schema": {
                  "type": "integer"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "$ref": "#/components/responses/ForbiddenError"
          },
          "422": {
            "$ref": "#/components/responses/ValidationError"
          },
          "304": {
            "$ref": "#/components/responses/NotModified"
          }
        }
      }
    },
    "/api/admin/security/test-event": {
      "post": {
        "summary": "Test WebSocket event",
        "description": "Trigger a test WebSocket event for development and testing. Requires SECURITY_ALLOW_TEST_EVENT=true",
        "tags": ["Testing"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "event": {
                    "type": "string",
                    "enum": ["login_failed", "key_revoked", "session_ended"],
                    "default": "login_failed"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Test event triggered successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TestEventResponse"
                }
              }
            }
          },
          "401": {
            "$ref": "#/components/responses/UnauthorizedError"
          },
          "403": {
            "$ref": "#/components/responses/ForbiddenError"
          },
          "422": {
            "$ref": "#/components/responses/ValidationError"
          },
          "503": {
            "description": "Test events disabled in production",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "SecurityKPIsResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "object",
            "properties": {
              "mfaAdoption": {
                "$ref": "#/components/schemas/KPIMetric"
              },
              "failedLogins": {
                "$ref": "#/components/schemas/KPIMetric"
              },
              "lockedAccounts": {
                "$ref": "#/components/schemas/KPIMetric"
              },
              "activeSessions": {
                "$ref": "#/components/schemas/KPIMetric"
              },
              "riskyKeys": {
                "$ref": "#/components/schemas/KPIMetric"
              },
              "loginAttempts": {
                "type": "object",
                "properties": {
                  "success": {
                    "type": "array",
                    "items": {
                      "type": "number"
                    }
                  },
                  "failed": {
                    "type": "array",
                    "items": {
                      "type": "number"
                    }
                  }
                }
              }
            }
          },
          "meta": {
            "$ref": "#/components/schemas/Meta"
          }
        }
      },
      "KPIMetric": {
        "type": "object",
        "properties": {
          "value": {
            "type": "number"
          },
          "deltaPct": {
            "type": "number"
          },
          "deltaAbs": {
            "type": "number"
          },
          "series": {
            "type": "array",
            "items": {
              "type": "number"
            }
          },
          "period": {
            "type": "string",
            "enum": ["7d", "30d", "90d"]
          }
        }
      },
      "MfaUsersResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/MfaUser"
            }
          },
          "meta": {
            "$ref": "#/components/schemas/PaginationMeta"
          }
        }
      },
      "MfaUser": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "name": {
            "type": "string"
          },
          "email": {
            "type": "string",
            "format": "email"
          },
          "role": {
            "type": "string",
            "description": "User role (super_admin, admin, manager, pm, member, client)"
          },
          "mfa_enabled": {
            "type": "boolean"
          },
          "last_login_at": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "LoginAttemptsResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/LoginAttempt"
            }
          },
          "meta": {
            "$ref": "#/components/schemas/PaginationMeta"
          }
        }
      },
      "LoginAttempt": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "user_email": {
            "type": "string",
            "format": "email"
          },
          "result": {
            "type": "string",
            "enum": ["success", "failed"]
          },
          "ip_address": {
            "type": "string"
          },
          "user_agent": {
            "type": "string"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "AuditLogsResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/AuditLog"
            }
          },
          "meta": {
            "$ref": "#/components/schemas/PaginationMeta"
          }
        }
      },
      "AuditLog": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "action": {
            "type": "string"
          },
          "user_email": {
            "type": "string",
            "format": "email"
          },
          "severity": {
            "type": "string",
            "enum": ["high", "medium", "low", "info"]
          },
          "result": {
            "type": "string",
            "enum": ["success", "failed"]
          },
          "ip_address": {
            "type": "string"
          },
          "user_agent": {
            "type": "string"
          },
          "details": {
            "type": "object"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "ActiveSessionsResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ActiveSession"
            }
          },
          "meta": {
            "$ref": "#/components/schemas/PaginationMeta"
          }
        }
      },
      "ActiveSession": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "name": {
            "type": "string"
          },
          "email": {
            "type": "string",
            "format": "email"
          },
          "ip_address": {
            "type": "string"
          },
          "user_agent": {
            "type": "string"
          },
          "last_seen": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "ForceMfaResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "object",
            "properties": {
              "success": {
                "type": "boolean"
              },
              "user_id": {
                "type": "integer"
              },
              "user_email": {
                "type": "string",
                "format": "email"
              },
              "forced_at": {
                "type": "string",
                "format": "date-time"
              }
            }
          }
        }
      },
      "TestEventResponse": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "broadcast_status": {
            "type": "string",
            "enum": ["success", "disabled"]
          },
          "note": {
            "type": "string",
            "nullable": true
          }
        }
      },
      "Meta": {
        "type": "object",
        "properties": {
          "generatedAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "PaginationMeta": {
        "type": "object",
        "properties": {
          "total": {
            "type": "integer"
          },
          "page": {
            "type": "integer"
          },
          "per_page": {
            "type": "integer"
          },
          "last_page": {
            "type": "integer"
          },
          "generatedAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Error": {
        "type": "object",
        "properties": {
          "error": {
            "type": "object",
            "properties": {
              "code": {
                "type": "string"
              },
              "message": {
                "type": "string"
              },
              "details": {
                "type": "object",
                "nullable": true
              }
            }
          }
        }
      },
      "RateLimitError": {
        "type": "object",
        "properties": {
          "error": {
            "type": "object",
            "properties": {
              "code": {
                "type": "string",
                "enum": ["RATE_LIMITED"]
              },
              "message": {
                "type": "string"
              }
            }
          }
        }
      },
      "ValidationError": {
        "type": "object",
        "properties": {
          "error": {
            "type": "object",
            "properties": {
              "code": {
                "type": "string",
                "enum": ["VALIDATION_ERROR"]
              },
              "message": {
                "type": "string"
              },
              "details": {
                "type": "object",
                "properties": {
                  "field": {
                    "type": "string"
                  },
                  "value": {
                    "type": "string"
                  },
                  "allowed": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "CsvExportResponse": {
        "type": "object",
        "properties": {
          "headers": {
            "type": "object",
            "properties": {
              "Content-Type": {
                "type": "string",
                "example": "text/csv; charset=UTF-8"
              },
              "Content-Disposition": {
                "type": "string",
                "example": "attachment; filename=audit_2025-09-28_15-50-09.csv"
              },
              "Cache-Control": {
                "type": "string",
                "example": "no-store"
              }
            }
          }
        }
      }
    },
    "responses": {
      "UnauthorizedError": {
        "description": "Authentication required",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      },
      "ForbiddenError": {
        "description": "Insufficient permissions",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      },
      "NotFoundError": {
        "description": "Resource not found",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            }
          }
        }
      },
      "ValidationError": {
        "description": "Validation error",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/ValidationError"
            }
          }
        }
      },
      "NotModified": {
        "description": "Resource not modified (ETag match)",
        "headers": {
          "ETag": {
            "description": "Entity tag for caching",
            "schema": {
              "type": "string"
            }
          }
        }
      }
    }
  },
  "tags": [
    {
      "name": "Security KPIs",
      "description": "Security metrics and KPIs"
    },
    {
      "name": "MFA Management",
      "description": "Multi-factor authentication management"
    },
    {
      "name": "Login Monitoring",
      "description": "Login attempts monitoring"
    },
    {
      "name": "Audit Logs",
      "description": "Audit logs and security events"
    },
    {
      "name": "Session Management",
      "description": "Active sessions management"
    },
    {
      "name": "Export",
      "description": "Data export functionality"
    },
    {
      "name": "Testing",
      "description": "Testing and development endpoints"
    }
  ]
}
