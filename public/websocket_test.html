<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZENA WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .log { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; height: 300px; overflow-y: auto; margin: 10px 0; }
        .controls { margin: 10px 0; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        input, select { padding: 5px; margin: 5px; }
        .message-form { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ZENA WebSocket Test Client</h1>
        
        <div id="status" class="status disconnected">Disconnected</div>
        
        <div class="controls">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
            <button onclick="ping()">Ping Server</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div class="message-form">
            <h3>Authentication</h3>
            <input type="number" id="userId" placeholder="User ID" value="1">
            <input type="text" id="token" placeholder="JWT Token" value="test-token">
            <button onclick="authenticate()">Authenticate</button>
        </div>
        
        <div class="message-form">
            <h3>Join Project Channel</h3>
            <input type="number" id="projectId" placeholder="Project ID" value="1">
            <button onclick="joinProject()">Join Project</button>
        </div>
        
        <div class="message-form">
            <h3>Send Notification</h3>
            <select id="targetType">
                <option value="user">User</option>
                <option value="project">Project</option>
            </select>
            <input type="number" id="targetId" placeholder="Target ID" value="1">
            <input type="text" id="notificationTitle" placeholder="Title" value="Test Notification">
            <input type="text" id="notificationBody" placeholder="Message" value="This is a test notification">
            <button onclick="sendNotification()">Send Notification</button>
        </div>
        
        <div class="log" id="log"></div>
        
        <button onclick="exportLog()">Export Log</button>
    </div>

    <script>
        let ws = null;
        let connectionId = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            if (connected) {
                statusDiv.textContent = `Connected (ID: ${connectionId})`;
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
            }
        }
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('Already connected', 'error');
                return;
            }
            
            try {
                ws = new WebSocket('ws://localhost:8080');
                
                ws.onopen = function(event) {
                    log('Connected to WebSocket server', 'success');
                    updateStatus(true);
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`Received: ${JSON.stringify(data, null, 2)}`);
                        
                        if (data.type === 'connection') {
                            connectionId = data.connection_id;
                            updateStatus(true);
                        }
                    } catch (e) {
                        log(`Received (raw): ${event.data}`);
                    }
                };
                
                ws.onclose = function(event) {
                    log('Connection closed', 'error');
                    updateStatus(false);
                    connectionId = null;
                };
                
                ws.onerror = function(error) {
                    log(`WebSocket error: ${error}`, 'error');
                };
                
            } catch (error) {
                log(`Connection error: ${error}`, 'error');
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function sendMessage(message) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected to server', 'error');
                return false;
            }
            
            try {
                ws.send(JSON.stringify(message));
                log(`Sent: ${JSON.stringify(message, null, 2)}`);
                return true;
            } catch (error) {
                log(`Send error: ${error}`, 'error');
                return false;
            }
        }
        
        function ping() {
            sendMessage({ type: 'ping' });
        }
        
        function authenticate() {
            const userId = document.getElementById('userId').value;
            const token = document.getElementById('token').value;
            
            sendMessage({
                type: 'auth',
                user_id: parseInt(userId),
                token: token
            });
        }
        
        function joinProject() {
            const projectId = document.getElementById('projectId').value;
            
            sendMessage({
                type: 'join_project',
                project_id: parseInt(projectId)
            });
        }
        
        function sendNotification() {
            const targetType = document.getElementById('targetType').value;
            const targetId = document.getElementById('targetId').value;
            const title = document.getElementById('notificationTitle').value;
            const body = document.getElementById('notificationBody').value;
            
            sendMessage({
                type: 'notification',
                target_type: targetType,
                target_id: parseInt(targetId),
                notification: {
                    title: title,
                    body: body,
                    priority: 'normal'
                }
            });
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function exportLog() {
            const logContent = document.getElementById('log').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `websocket-log-${new Date().toISOString().slice(0, 19)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Auto-connect on page load
        window.onload = function() {
            log('WebSocket test client loaded');
        };
    </script>
</body>
</html>