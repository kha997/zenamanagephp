#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="/Applications/XAMPP/xamppfiles/htdocs/zenamanage-golden"

cd "$REPO_ROOT"

export APP_ENV=testing
export DB_CONNECTION=mysql
export PCOV_ENABLED=0

export DB_HOST=${DB_HOST:-mysql}
export DB_PORT=${DB_PORT:-3306}
export DB_DATABASE=${DB_DATABASE:-zenamanage_test}
export DB_USERNAME=${DB_USERNAME:-root}
export DB_PASSWORD=${DB_PASSWORD:-}

print_zena_config() {
    php -r '
require "vendor/autoload.php";
$app = require "bootstrap/app.php";
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();
printf(
    "ZENA INVARIANTS MYSQL CONFIG: env=%s | default=%s | mysql_host=%s | mysql_port=%s | mysql_db=%s | mysql_user=%s | mysql_pw=%s\n",
    $app->environment(),
    config("database.default"),
    config("database.connections.mysql.host") ?? "null",
    config("database.connections.mysql.port") ?? "null",
    config("database.connections.mysql.database") ?? "null",
    config("database.connections.mysql.username") ?? "null",
    empty(config("database.connections.mysql.password")) ? "EMPTY" : "SET"
);
'
}

ensure_mysql_connection() {
    DEFAULT_CONNECTION=$(php -r '
require "vendor/autoload.php";
$app = require "bootstrap/app.php";
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();
printf("%s", config("database.default"));
')

    if [[ "$DEFAULT_CONNECTION" != "mysql" ]]; then
        echo "ERROR: zena-invariants-mysql requires mysql but database.default is '$DEFAULT_CONNECTION'."
        exit 1
    fi
}

mysql_preflight_connection() {
    php -r '
try {
    $host = getenv("DB_HOST") ?: "mysql";
    $port = getenv("DB_PORT") ?: 3306;
    $db = getenv("DB_DATABASE") ?: "zenamanage_test";
    $user = getenv("DB_USERNAME") ?: "root";
    $pass = getenv("DB_PASSWORD") ?: "";
    $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s", $host, $port, $db);
    new PDO($dsn, $user, $pass, [PDO::ATTR_TIMEOUT => 5, PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);
    printf("Preflight MySQL connection succeeded (%s:%s/%s)\n", $host, $port, $db);
} catch (Throwable $e) {
    fwrite(STDERR, "MySQL connection preflight failed: " . $e->getMessage() . "\n");
    exit(1);
}
'
}

print_zena_config
ensure_mysql_connection
mysql_preflight_connection

php artisan optimize:clear
php artisan migrate:fresh --force
php artisan migrate:status
php artisan test --group=zena-invariants -v
