#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"

cd "$ROOT_DIR"

export APP_ENV=testing
export DB_CONNECTION=mysql
export PCOV_ENABLED=0

resolve_with_precedence() {
    local default_value="$1"
    shift
    local env_var
    for env_var in "$@"; do
        local env_value
        env_value="${!env_var:-}"
        if [[ -n "$env_value" ]]; then
            printf '%s' "$env_value"
            return 0
        fi
    done
    printf '%s' "$default_value"
}

resolve_host_with_fallback() {
    local host="$1"
    if [[ "$host" != "mysql" ]]; then
        printf '%s' "$host"
        return 0
    fi

    # Guard against macOS not resolving "mysql" by falling back to localhost.
    if python3 -c 'import socket, sys; socket.gethostbyname(sys.argv[1])' "$host" >/dev/null 2>&1; then
        printf '%s' "$host"
    else
        printf '127.0.0.1'
    fi
}

RESOLVED_DB_HOST=$(resolve_with_precedence "mysql" MYSQL_HOST ZENA_MYSQL_HOST DB_HOST)
RESOLVED_DB_HOST=$(resolve_host_with_fallback "$RESOLVED_DB_HOST")
RESOLVED_DB_PORT=$(resolve_with_precedence "3306" MYSQL_PORT ZENA_MYSQL_PORT DB_PORT)
RESOLVED_DB_DATABASE=$(resolve_with_precedence "zenamanage_test" MYSQL_DATABASE ZENA_MYSQL_DATABASE DB_DATABASE)
RESOLVED_DB_USERNAME=$(resolve_with_precedence "root" MYSQL_USERNAME ZENA_MYSQL_USERNAME DB_USERNAME)
RESOLVED_DB_PASSWORD=$(resolve_with_precedence "" MYSQL_PASSWORD ZENA_MYSQL_PASSWORD DB_PASSWORD)

export DB_HOST="$RESOLVED_DB_HOST"
export DB_PORT="$RESOLVED_DB_PORT"
export DB_DATABASE="$RESOLVED_DB_DATABASE"
export DB_USERNAME="$RESOLVED_DB_USERNAME"
export DB_PASSWORD="$RESOLVED_DB_PASSWORD"
export ZENA_INVARIANTS_DB=mysql

print_zena_config() {
    php -r '
require "vendor/autoload.php";
$app = require "bootstrap/app.php";
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();
    printf(
        "ZENA INVARIANTS MYSQL CONFIG: env=%s | mode=%s | default=%s | mysql_host=%s | mysql_port=%s | mysql_db=%s | mysql_user=%s | mysql_pw=%s\n",
        $app->environment(),
        getenv("ZENA_INVARIANTS_DB") ?: "unset",
        config("database.default"),
        config("database.connections.mysql.host") ?? "null",
        config("database.connections.mysql.port") ?? "null",
        config("database.connections.mysql.database") ?? "null",
        config("database.connections.mysql.username") ?? "null",
        empty(config("database.connections.mysql.password")) ? "EMPTY" : "SET"
    );
'
}

ensure_mysql_connection() {
    DEFAULT_CONNECTION=$(php -r '
require "vendor/autoload.php";
$app = require "bootstrap/app.php";
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();
printf("%s", config("database.default"));
')

    if [[ "$DEFAULT_CONNECTION" != "mysql" ]]; then
        echo "ERROR: zena-invariants-mysql requires mysql but database.default is '$DEFAULT_CONNECTION'."
        exit 1
    fi
}

mysql_preflight_connection() {
    php -r '
try {
    $host = getenv("DB_HOST") ?: "mysql";
    $port = getenv("DB_PORT") ?: 3306;
    $db = getenv("DB_DATABASE") ?: "zenamanage_test";
    $user = getenv("DB_USERNAME") ?: "root";
    $pass = getenv("DB_PASSWORD") ?: "";
    $dsn = sprintf("mysql:host=%s;port=%s;dbname=%s", $host, $port, $db);
    new PDO($dsn, $user, $pass, [PDO::ATTR_TIMEOUT => 5, PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);
    printf("Preflight MySQL connection succeeded (%s:%s/%s)\n", $host, $port, $db);
} catch (Throwable $e) {
    fwrite(STDERR, "MySQL connection preflight failed: " . $e->getMessage() . "\n");
    exit(1);
}
'
}

print_zena_config
ensure_mysql_connection
mysql_preflight_connection

mkdir -p resources/views storage/framework/views storage/framework/cache bootstrap/cache

php artisan optimize:clear
php artisan migrate:fresh --force
php artisan migrate:status
php artisan test --group=zena-invariants -v
