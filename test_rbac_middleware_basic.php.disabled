<?php declare(strict_types=1);

/**
 * Script test ch·ª©c nƒÉng c∆° b·∫£n c·ªßa RBAC middleware
 * T·∫°o route test ƒë∆°n gi·∫£n v√† ki·ªÉm tra RBAC ho·∫°t ƒë·ªông
 */

require_once __DIR__ . '/bootstrap.php';

echo "üß™ Test ch·ª©c nƒÉng c∆° b·∫£n RBAC middleware...\n\n";

try {
    // ƒêo·∫°n route test d√πng FQCN (kh√¥ng c·∫ßn use), c√≥ prefix v1, guard api, v√† nullsafe cho user
    $testRouteContent = <<<'PHP'

// Test route cho RBAC middleware
\Illuminate\Support\Facades\Route::prefix('v1')
    ->middleware(['auth:api', 'rbac:project.view'])
    ->get('rbac-test', function (\Illuminate\Http\Request $request) {
        return response()->json([
            'status' => 'success',
            'message' => 'RBAC middleware ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!',
            'user_id' => $request->user('api')?->id,
            'permissions' => $request->get('user_permissions', []),
            'timestamp' => now()->toIso8601String(),
        ]);
    });
PHP;

    // ƒê·ªçc file routes/api.php hi·ªán t·∫°i
    $apiRoutesPath = __DIR__ . '/routes/api.php';
    $currentContent = file_get_contents($apiRoutesPath);

    // Backup file g·ªëc
    $backupPath = $apiRoutesPath . '.backup_rbac_test_' . date('Y-m-d_H-i-s');
    file_put_contents($backupPath, $currentContent);
    echo "üìÅ ƒê√£ backup routes/api.php -> {$backupPath}\n";

    // Th√™m test route v√†o cu·ªëi file (tr∆∞·ªõc d·∫•u ?> n·∫øu c√≥)
    $newContent = rtrim($currentContent);
    if (substr($newContent, -2) === '?>') {
        $newContent = substr($newContent, 0, -2) . "\n" . $testRouteContent . "\n?>";
    } else {
        $newContent .= "\n" . $testRouteContent . "\n";
    }

    file_put_contents($apiRoutesPath, $newContent);
    echo "‚úÖ ƒê√£ th√™m test route v√†o routes/api.php\n";

    // Clear route cache
    echo "\nüîÑ Clearing route cache...\n";
    $cmd = 'cd ' . escapeshellarg(__DIR__) . ' && php artisan route:clear 2>&1';
    exec($cmd, $output, $returnCode);

    if ($returnCode === 0) {
        echo "‚úÖ Route cache cleared successfully\n";
    } else {
        echo "‚ö†Ô∏è  Route cache clear warning:\n" . implode("\n", $output) . "\n";
    }

    echo "\nüìã H∆∞·ªõng d·∫´n test:\n";
    echo "1) T·∫°o JWT token cho user c√≥ quy·ªÅn project.view\n";
    echo "2) G·ªçi: GET /api/v1/rbac-test v·ªõi header Authorization: Bearer <token>\n";
    echo "3) Response s·∫Ω ch·ª©a user_id, permissions\n";

    echo "\nüîß L·ªánh test m·∫´u:\n";
    echo "curl -X GET http://localhost/zenamanage/public/api/v1/rbac-test \\\n";
    echo "  -H 'Authorization: Bearer YOUR_JWT_TOKEN' \\\n";
    echo "  -H 'Content-Type: application/json'\n";

    echo "\nüóëÔ∏è  X√≥a test route khi xong:\n";
    echo "cp {$backupPath} {$apiRoutesPath} && php artisan route:clear\n";

} catch (Exception $e) {
    echo "‚ùå L·ªói khi t·∫°o test route: " . $e->getMessage() . "\n";
    echo "üìç File: " . $e->getFile() . " (d√≤ng " . $e->getLine() . ")\n";
    exit(1);
}