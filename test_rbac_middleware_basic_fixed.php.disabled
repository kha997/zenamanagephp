<?php declare(strict_types=1);

/**
 * Script test ch·ª©c nƒÉng c∆° b·∫£n c·ªßa RBAC middleware (phi√™n b·∫£n ƒë√£ s·ª≠a l·ªói)
 * T·∫°o route test ƒë∆°n gi·∫£n v√† ki·ªÉm tra RBAC ho·∫°t ƒë·ªông
 */

require_once __DIR__ . '/bootstrap.php';

echo "üß™ Test ch·ª©c nƒÉng c∆° b·∫£n RBAC middleware...\n\n";

try {
    // T·∫°o n·ªôi dung test route (s·ª≠ d·ª•ng string concatenation thay v√¨ heredoc)
    $testRouteContent = "\n// Test route cho RBAC middleware\n";
    $testRouteContent .= "\\Illuminate\\Support\\Facades\\Route::prefix('v1')\n";
    $testRouteContent .= "    ->middleware(['auth:api', 'rbac:project.view'])\n";
    $testRouteContent .= "    ->get('rbac-test', function (\\Illuminate\\Http\\Request \$request) {\n";
    $testRouteContent .= "        return response()->json([\n";
    $testRouteContent .= "            'status' => 'success',\n";
    $testRouteContent .= "            'message' => 'RBAC middleware ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!',\n";
    $testRouteContent .= "            'user_id' => \$request->user('api')?->id,\n";
    $testRouteContent .= "            'permissions' => \$request->get('user_permissions', []),\n";
    $testRouteContent .= "            'timestamp' => now()->toIso8601String(),\n";
    $testRouteContent .= "        ]);\n";
    $testRouteContent .= "    });\n";

    // ƒê·ªçc file routes/api.php hi·ªán t·∫°i
    $apiRoutesPath = __DIR__ . '/routes/api.php';
    $currentContent = file_get_contents($apiRoutesPath);

    // Backup file g·ªëc
    $backupPath = $apiRoutesPath . '.backup_rbac_test_' . date('Y-m-d_H-i-s');
    file_put_contents($backupPath, $currentContent);
    echo "üìÅ ƒê√£ backup routes/api.php -> {$backupPath}\n";

    // Th√™m test route v√†o cu·ªëi file (tr∆∞·ªõc d·∫•u ?> n·∫øu c√≥)
    $newContent = rtrim($currentContent);
    if (substr($newContent, -2) === '?>') {
        $newContent = substr($newContent, 0, -2) . "\n" . $testRouteContent . "\n?>";
    } else {
        $newContent .= "\n" . $testRouteContent . "\n";
    }

    file_put_contents($apiRoutesPath, $newContent);
    echo "‚úÖ ƒê√£ th√™m test route v√†o routes/api.php\n";

    // Clear route cache
    echo "\nüîÑ Clearing route cache...\n";
    $cmd = 'cd ' . escapeshellarg(__DIR__) . ' && php artisan route:clear 2>&1';
    exec($cmd, $output, $returnCode);

    if ($returnCode === 0) {
        echo "‚úÖ Route cache cleared successfully\n";
    } else {
        echo "‚ö†Ô∏è  Route cache clear warning:\n" . implode("\n", $output) . "\n";
    }

    echo "\nüìã H∆∞·ªõng d·∫´n test:\n";
    echo "1) T·∫°o JWT token cho user c√≥ quy·ªÅn project.view\n";
    echo "2) G·ªçi: GET /api/v1/rbac-test v·ªõi header Authorization: Bearer <token>\n";
    echo "3) Response s·∫Ω ch·ª©a user_id, permissions\n";

    echo "\nüîß L·ªánh test m·∫´u:\n";
    echo "curl -X GET http://localhost/zenamanage/public/api/v1/rbac-test \\\n";
    echo "  -H 'Authorization: Bearer YOUR_JWT_TOKEN' \\\n";
    echo "  -H 'Content-Type: application/json'\n";

    echo "\nüóëÔ∏è  X√≥a test route khi xong:\n";
    echo "cp {$backupPath} {$apiRoutesPath} && php artisan route:clear\n";

} catch (Exception $e) {
    echo "‚ùå L·ªói khi t·∫°o test route: " . $e->getMessage() . "\n";
    echo "üìç File: " . $e->getFile() . " (d√≤ng " . $e->getLine() . ")\n";
    exit(1);
}

echo "\n‚úÖ Script ho√†n th√†nh th√†nh c√¥ng!\n";