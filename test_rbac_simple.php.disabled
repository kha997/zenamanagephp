<?php declare(strict_types=1);

/**
 * Script test RBAC middleware Ä‘Æ¡n giáº£n
 */

require_once __DIR__ . '/bootstrap.php';

echo "ğŸ§ª Test RBAC middleware...\n\n";

try {
    // Äá»c file routes/api.php hiá»‡n táº¡i
    $apiRoutesPath = __DIR__ . '/routes/api.php';
    $currentContent = file_get_contents($apiRoutesPath);

    // Backup file gá»‘c
    $backupPath = $apiRoutesPath . '.backup_' . date('Y-m-d_H-i-s');
    file_put_contents($backupPath, $currentContent);
    echo "ğŸ“ Backup: {$backupPath}\n";

    // Táº¡o test route Ä‘Æ¡n giáº£n
    $testRoute = "\n\n// RBAC Test Route\n";
    $testRoute .= "Route::prefix('v1')->middleware(['auth:api', 'rbac:project.view'])->get('rbac-test', function (Request \$request) {\n";
    $testRoute .= "    return response()->json([\n";
    $testRoute .= "        'status' => 'success',\n";
    $testRoute .= "        'message' => 'RBAC OK',\n";
    $testRoute .= "        'user_id' => \$request->user('api')?->id,\n";
    $testRoute .= "        'timestamp' => now()->toIso8601String()\n";
    $testRoute .= "    ]);\n";
    $testRoute .= "});\n";

    // ThÃªm vÃ o cuá»‘i file
    $newContent = rtrim($currentContent);
    if (substr($newContent, -2) === '?>') {
        $newContent = substr($newContent, 0, -2) . $testRoute . "\n?>";
    } else {
        $newContent .= $testRoute;
    }

    file_put_contents($apiRoutesPath, $newContent);
    echo "âœ… ÄÃ£ thÃªm test route\n";

    // Clear cache
    echo "\nğŸ”„ Clearing cache...\n";
    $output = [];
    exec('cd ' . escapeshellarg(__DIR__) . ' && php artisan route:clear 2>&1', $output);
    echo implode("\n", $output) . "\n";

    echo "\nğŸ“‹ Test vá»›i:\n";
    echo "GET /api/v1/rbac-test\n";
    echo "Header: Authorization: Bearer YOUR_JWT_TOKEN\n";
    echo "\nğŸ—‘ï¸  Restore: cp {$backupPath} {$apiRoutesPath}\n";

} catch (Exception $e) {
    echo "âŒ Lá»—i: " . $e->getMessage() . "\n";
    exit(1);
}

echo "\nâœ… HoÃ n thÃ nh!\n";