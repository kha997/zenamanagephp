import { test, expect } from '@playwright/test';
import { AuthHelper } from '../helpers/auth-helper';

test.describe('Debug Login', () => {
  test('should be able to login and access dashboard', async ({ page }) => {
    const authHelper = new AuthHelper(page);
    
    // Go to login page
    await page.goto('/login');
    console.log('Current URL after going to login:', page.url());
    
    // Fill in credentials
    await page.fill('input[name="email"]', 'uat-pm@test.com');
    await page.fill('input[name="password"]', 'password');
    
    // Click submit and wait for navigation
    await page.click('button[type="submit"]');
    
    // Wait for the AJAX request to complete and redirect to happen
    // The login form waits 2 seconds before redirecting
    await page.waitForURL('**/app/**', { timeout: 10000 });
    console.log('Current URL after login:', page.url());
    
    // Check if we're on an app page
    expect(page.url()).toMatch(/\/app\//);
    
    // Try to go to dashboard directly
    await page.goto('/app/dashboard');
    await page.waitForLoadState('networkidle');
    console.log('Current URL after going to dashboard:', page.url());
    
    // Check if we can find the user menu
    const userMenu = await page.locator('[data-testid="user-menu"]');
    const userMenuExists = await userMenu.count() > 0;
    console.log('User menu exists:', userMenuExists);
    
    if (userMenuExists) {
      console.log('User menu found!');
    } else {
      console.log('User menu not found. Page content:');
      const content = await page.content();
      console.log(content.substring(0, 1000));
    }
  });
});
